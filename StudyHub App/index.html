<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chris StudyHub</title>
    <meta property="og:title" content="Chris StudyHub">
    <meta property="og:description" content="מארגן לימודים אישי">
    <meta property="og:type" content="website">
    <meta name="description" content="Chris StudyHub - מארגן לימודים אישי">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Performance optimizations */
        *, *::before, *::after {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .item-card, .course-card, .modal, .item-detail, .back-btn, .btn, .detail-btn, .category-tab {
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(236, 72, 153, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(34, 211, 238, 0.1) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        /* Sidebar */
        .sidebar {
            width: 200px;
            background: rgba(15, 12, 41, 0.95);
            border-left: 1px solid rgba(139, 92, 246, 0.2);
            padding: 20px 0;
            height: 100vh;
            position: fixed;
            right: 0;
            z-index: 10;
        }

        .sidebar-header {
            padding: 10px 20px 25px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
            margin-bottom: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899, #22d3ee);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
            animation: pulse 3s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }
            50% { box-shadow: 0 0 30px rgba(236, 72, 153, 0.6); }
        }

        .logo h1 {
            font-size: 1.2rem;
            background: linear-gradient(135deg, #fff, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }


        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.15s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            border-right: 3px solid transparent;
            color: #a78bfa;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
            background: transparent;
            border: none;
            border-right: 3px solid transparent;
            font-family: inherit;
            font-size: inherit;
            outline: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .menu-item:hover {
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.15));
            color: #fff;
        }

        .menu-item:active {
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.35));
            transform: scale(0.98);
        }

        .menu-item.active {
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.25));
            border-right-color: #ec4899;
            color: #fff;
            text-shadow: 0 0 20px rgba(236, 72, 153, 0.5);
        }

        /* Main Content */
        .main {
            margin-right: 200px;
            flex: 1;
            padding: 0 30px 30px 30px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Back Button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 28px;
            background: rgba(15, 12, 41, 0.95);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            color: #a78bfa;
            cursor: pointer;
            font-size: 1.05rem;
            font-family: inherit;
            transition: all 0.15s ease-out;
            position: fixed;
            top: 15px;
            right: 215px;
            z-index: 100;
        }

        .back-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8b5cf6;
            color: #fff;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }

        /* Page Title */
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #fff, #a78bfa, #f472b6, #22d3ee);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        /* Course Grid */
        .course-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 18px;
            padding-left: 80px;
            margin-top: 60px;
        }

        .course-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 36px;
            padding: 30px;
            cursor: pointer;
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, border-color 0.15s ease-out;
            position: relative;
            overflow: hidden;
            aspect-ratio: 2 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .course-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--color), transparent);
        }

        .course-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 0%, var(--color), transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .course-card:hover {
            transform: translateY(-5px);
            border-color: var(--color);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }

        .course-card:hover::after { opacity: 0.1; }

        .course-card-icon {
            width: 110px;
            height: 110px;
            background: linear-gradient(135deg, var(--color), color-mix(in srgb, var(--color) 60%, #ec4899));
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 44px;
            margin-bottom: 36px;
            box-shadow: 0 8px 25px color-mix(in srgb, var(--color) 40%, transparent);
            position: relative;
            z-index: 1;
        }

        .course-card-name {
            font-size: 2.4rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--color);
            position: relative;
            z-index: 1;
            text-shadow: 0 0 30px color-mix(in srgb, var(--color) 50%, transparent);
        }

        .course-card-count {
            font-size: 1.7rem;
            color: #a78bfa;
            position: relative;
            z-index: 1;
        }

        /* Category Bar */
        .category-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            padding: 12px;
            background: rgba(15, 12, 41, 0.85);
            border-radius: 14px;
            overflow-x: auto;
            white-space: nowrap;
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .category-bar::-webkit-scrollbar { height: 6px; }
        .category-bar::-webkit-scrollbar-track { background: rgba(139, 92, 246, 0.1); border-radius: 3px; }
        .category-bar::-webkit-scrollbar-thumb { background: linear-gradient(90deg, #8b5cf6, #ec4899); border-radius: 3px; }

        .category-tab {
            padding: 10px 18px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            color: #a78bfa;
            cursor: pointer;
            font-size: 0.85rem;
            font-family: inherit;
            transition: all 0.15s ease-out;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .category-tab:hover {
            background: rgba(139, 92, 246, 0.2);
            color: #fff;
            border-color: #8b5cf6;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.2);
        }
        .category-tab.active {
            background: linear-gradient(135deg, var(--color), color-mix(in srgb, var(--color) 70%, #ec4899));
            border-color: var(--color);
            color: #fff;
            box-shadow: 0 4px 20px color-mix(in srgb, var(--color) 40%, transparent);
        }
        .category-tab .count {
            background: rgba(255,255,255,0.2);
            padding: 2px 7px;
            border-radius: 6px;
            font-size: 0.75rem;
        }

        /* Items Header */
        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .items-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #e0e7ff;
        }

        .add-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899, #22d3ee);
            background-size: 200% auto;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease-out;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.4), 0 0 20px rgba(236, 72, 153, 0.3);
            background-position: right center;
        }

        /* Items Grid */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
        }

        .item-card {
            background: linear-gradient(135deg, color-mix(in srgb, var(--color) 12%, transparent) 0%, color-mix(in srgb, var(--color) 5%, transparent) 100%);
            border: 1px solid color-mix(in srgb, var(--color) 25%, transparent);
            border-radius: 18px;
            padding: 25px;
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, border-color 0.15s ease-out;
        }

        .item-card:hover {
            border-color: color-mix(in srgb, var(--color) 50%, transparent);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .item-card.has-file {
            border-color: rgba(16, 185, 129, 0.5);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, color-mix(in srgb, var(--color) 8%, transparent) 100%);
        }

        .item-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
        }

        .item-checkbox {
            width: 26px;
            height: 26px;
            border: 2px solid rgba(139, 92, 246, 0.4);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease-out;
            flex-shrink: 0;
        }

        .item-checkbox:hover {
            border-color: var(--color);
            box-shadow: 0 0 10px color-mix(in srgb, var(--color) 30%, transparent);
        }
        .item-checkbox.checked {
            background: linear-gradient(135deg, var(--color), #ec4899);
            border-color: var(--color);
            box-shadow: 0 0 15px color-mix(in srgb, var(--color) 40%, transparent);
        }
        .item-checkbox i { display: none; font-size: 12px; }
        .item-checkbox.checked i { display: block; }

        .item-info { flex: 1; text-align: center; }
        .item-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: var(--color); text-shadow: 0 0 20px color-mix(in srgb, var(--color) 30%, transparent); }
        .item-card.completed .item-title { text-decoration: line-through; opacity: 0.5; }

        .item-meta {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--color);
            opacity: 0.8;
        }

        .item-meta i { margin-left: 4px; }

        .uploaders-list {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid color-mix(in srgb, var(--color) 15%, transparent);
        }

        .uploader-line {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: #a78bfa;
            padding: 4px 0;
        }

        .uploader-line i {
            color: var(--color);
            font-size: 0.75rem;
        }

        .uploader-count {
            background: rgba(139, 92, 246, 0.15);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            color: #c4b5fd;
            margin-right: auto;
        }

        .item-notes {
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid color-mix(in srgb, var(--color) 15%, transparent);
        }

        .item-notes textarea {
            width: 100%;
            min-height: 60px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid color-mix(in srgb, var(--color) 20%, transparent);
            border-radius: 10px;
            color: #e0e7ff;
            font-family: inherit;
            font-size: 0.85rem;
            resize: vertical;
            transition: all 0.15s ease-out;
        }

        .item-notes textarea::placeholder {
            color: rgba(167, 139, 250, 0.5);
        }

        .item-notes textarea:focus {
            outline: none;
            border-color: var(--color);
            box-shadow: 0 0 15px color-mix(in srgb, var(--color) 20%, transparent);
        }

        .item-notes-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--color);
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .notes-section {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            padding: 10px 15px;
            max-width: 100%;
            margin: 0 auto;
        }

        .note-item {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .note-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }

        .note-author {
            color: #a78bfa;
            font-weight: 500;
        }

        .note-author i {
            margin-left: 4px;
        }

        .note-date {
            color: #6b7280;
            font-size: 0.75rem;
        }

        .note-delete {
            margin-right: auto;
            background: none;
            border: none;
            color: #f87171;
            cursor: pointer;
            padding: 4px;
            opacity: 0.6;
            transition: all 0.15s ease-out;
        }

        .note-delete:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .note-text {
            color: #e0e7ff;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .add-note-form {
            margin-top: 10px;
            text-align: center;
        }

        .add-note-form textarea {
            width: 100%;
            min-height: 45px;
            padding: 8px 10px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            color: #e0e7ff;
            font-family: inherit;
            font-size: 0.85rem;
            resize: vertical;
            transition: all 0.15s ease-out;
        }

        .add-note-form textarea::placeholder {
            color: rgba(167, 139, 250, 0.5);
        }

        .add-note-form textarea:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.2);
        }

        .item-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid color-mix(in srgb, var(--color) 15%, transparent);
            justify-content: center;
        }

        .item-action-btn {
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s ease-out;
            display: flex;
            align-items: center;
            gap: 6px;
            border: none;
        }

        .item-action-btn.view {
            background: linear-gradient(135deg, var(--color), color-mix(in srgb, var(--color) 70%, #ec4899));
            color: white;
        }
        .item-action-btn.view:hover {
            box-shadow: 0 4px 15px color-mix(in srgb, var(--color) 40%, transparent);
            transform: translateY(-2px);
        }

        .item-action-btn.download {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #a78bfa;
        }
        .item-action-btn.download:hover {
            background: rgba(139, 92, 246, 0.2);
            color: #fff;
        }

        .item-action-btn.delete {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }
        .item-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .item-action-btn.more {
            background: rgba(34, 211, 238, 0.1);
            border: 1px solid rgba(34, 211, 238, 0.3);
            color: #22d3ee;
        }
        .item-action-btn.more:hover {
            background: rgba(34, 211, 238, 0.2);
            color: #fff;
        }

        .item-file-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #34d399;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(34, 211, 238, 0.1));
            padding: 3px 8px;
            border-radius: 5px;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Item Detail View */
        .item-detail {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(236, 72, 153, 0.06) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 24px;
            padding: 30px 60px 50px 60px;
            max-width: 1100px;
            margin: 0 auto;
        }

        .item-detail-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .item-detail-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--color), #ec4899);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 8px 25px color-mix(in srgb, var(--color) 40%, transparent);
        }

        .item-detail-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #e0e7ff;
            text-align: center;
        }

        .item-detail-section {
            margin-bottom: 30px;
        }

        .item-detail-section h4 {
            font-size: 1.1rem;
            color: #a78bfa;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
        }

        .item-detail-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 15px 20px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 12px;
            font-size: 1rem;
            color: #e0e7ff;
        }

        .item-detail-info i { color: var(--color); width: 20px; }

        .file-preview {
            padding: 20px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(34, 211, 238, 0.1));
            border: 2px solid rgba(16, 185, 129, 0.4);
            border-radius: 12px;
            text-align: center;
        }

        .file-preview i { font-size: 3rem; color: #34d399; margin-bottom: 15px; text-shadow: 0 0 30px rgba(16, 185, 129, 0.5); }
        .file-preview h4 { margin-bottom: 5px; color: #e0e7ff; }
        .file-preview p { font-size: 0.85rem; color: #34d399; margin-bottom: 15px; }

        .file-preview-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .no-file {
            padding: 40px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(236, 72, 153, 0.03));
            border: 2px dashed rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            text-align: center;
            color: #a78bfa;
            cursor: pointer;
            transition: all 0.15s ease-out;
        }

        .no-file:hover {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.05));
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.2);
        }
        .no-file.drag-over {
            border-color: #22d3ee;
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.15), rgba(16, 185, 129, 0.1));
            transform: scale(1.02);
            box-shadow: 0 0 40px rgba(34, 211, 238, 0.3);
        }
        .no-file i { font-size: 2.5rem; margin-bottom: 15px; opacity: 0.7; transition: all 0.15s ease-out; color: #a78bfa; }
        .no-file:hover i { opacity: 1; color: #ec4899; }
        .no-file.drag-over i { opacity: 1; color: #22d3ee; }

        .detail-actions {
            display: flex;
            gap: 15px;
            margin-top: 35px;
            padding-top: 25px;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            justify-content: center;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .detail-btn {
            flex: 1;
            padding: 18px 35px;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .detail-return-wrapper {
            display: flex;
            justify-content: flex-start;
            margin-top: 20px;
        }

        .detail-btn-return {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            border: none;
            color: white;
            flex: none;
            padding: 12px 22px;
            font-size: 0.95rem;
            border-radius: 10px;
        }

        .detail-btn-return:hover {
            background: linear-gradient(135deg, #7c3aed, #8b5cf6);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
        }

        .detail-btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #ec4899, #22d3ee);
            background-size: 200% auto;
            border: none;
            color: white;
        }

        .detail-btn-primary:hover {
            background-position: right center;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .detail-btn-secondary {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #a78bfa;
        }

        .detail-btn-secondary:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8b5cf6;
            color: #fff;
        }

        .detail-btn-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .detail-btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
        }

        /* Empty State */
        .empty-state {
            grid-column: 1/-1;
            text-align: center;
            padding: 50px;
            color: #a78bfa;
        }

        .empty-state i { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.5; color: #8b5cf6; }
        .empty-state h3 { color: #e0e7ff; margin-bottom: 8px; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 12, 41, 0.9);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: linear-gradient(135deg, #1a1a2e, #302b63);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 18px;
            width: 100%;
            max-width: 420px;
            animation: modalIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5), 0 0 60px rgba(139, 92, 246, 0.15);
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            padding: 18px 22px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1rem;
            color: #e0e7ff;
            background: linear-gradient(135deg, #fff, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .modal-close {
            width: 30px;
            height: 30px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            color: #a78bfa;
            cursor: pointer;
            transition: all 0.15s ease-out;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            color: #f87171;
        }

        .modal-body { padding: 18px 22px; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 0.8rem; color: #a78bfa; margin-bottom: 6px; }

        .form-group input {
            width: 100%;
            padding: 11px 14px;
            background: rgba(139, 92, 246, 0.08);
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 9px;
            color: #fff;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.15s ease-out;
        }

        .form-group input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
        }

        .file-drop {
            border: 2px dashed rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease-out;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(236, 72, 153, 0.03));
        }

        .file-drop:hover {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.05));
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.15);
        }
        .file-drop.drag-over {
            border-color: #22d3ee;
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.15), rgba(16, 185, 129, 0.1));
            transform: scale(1.02);
        }
        .file-drop i { font-size: 1.8rem; color: #a78bfa; margin-bottom: 8px; }
        .file-drop:hover i { color: #ec4899; }
        .file-drop.drag-over i { color: #22d3ee; }
        .file-drop h4 { color: #e0e7ff; }
        .file-drop p { color: #a78bfa; }

        .file-attached {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(34, 211, 238, 0.1));
            border: 2px solid rgba(16, 185, 129, 0.4);
            border-radius: 9px;
        }

        .file-attached i { font-size: 1.3rem; color: #34d399; }
        .file-attached-info { flex: 1; }
        .file-attached-info h4 { font-size: 0.85rem; margin-bottom: 2px; color: #e0e7ff; }
        .file-attached-info p { font-size: 0.7rem; color: #34d399; }
        .file-attached button { background: none; border: none; color: #f87171; cursor: pointer; transition: all 0.15s ease-out; }
        .file-attached button:hover { color: #ef4444; transform: scale(1.1); }

        .modal-footer {
            padding: 14px 22px;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 11px 16px;
            border-radius: 9px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s ease-out;
        }

        .btn-secondary {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #a78bfa;
        }

        .btn-secondary:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8b5cf6;
            color: #fff;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #ec4899, #22d3ee);
            background-size: 200% auto;
            border: none;
            color: white;
        }

        .btn-primary:hover {
            background-position: right center;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #f87171;
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, #10b981, #22d3ee);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4), 0 0 30px rgba(34, 211, 238, 0.2);
            z-index: 2000;
            opacity: 0;
            transition: all 0.2s ease-out cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast i { font-size: 1.2rem; text-shadow: 0 0 15px rgba(255,255,255,0.5); }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(236, 72, 153, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(34, 211, 238, 0.1) 0%, transparent 60%);
            pointer-events: none;
        }

        .login-box {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5), 0 0 60px rgba(139, 92, 246, 0.15);
        }

        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .login-logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899, #22d3ee);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
            color: white;
        }

        .login-logo h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #fff, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-title {
            text-align: center;
            color: #e0e7ff;
            margin-bottom: 25px;
            font-size: 1.1rem;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form .form-group label {
            display: block;
            color: #a78bfa;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .login-form .form-group input {
            width: 100%;
            padding: 14px 18px;
            background: rgba(139, 92, 246, 0.08);
            border: 2px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.15s ease-out;
        }

        .login-form .form-group input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899, #22d3ee);
            background-size: 200% auto;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-btn:hover {
            background-position: right center;
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
        }

        .login-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            padding: 12px;
            color: #f87171;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            transition: all 0.15s ease-out;
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 15px 20px;
            position: absolute;
            bottom: 20px;
            right: 0;
            left: 0;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* Notification Bell Styles */
        .notification-bell {
            position: fixed;
            -webkit-position: fixed;
            top: 20px;
            left: 20px;
            width: 55px;
            height: 55px;
            background: rgba(15, 12, 41, 0.95);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 14px;
            -webkit-border-radius: 14px;
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            -webkit-justify-content: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9998;
            -webkit-transition: all 0.15s ease-out;
            transition: all 0.15s ease-out;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        .notification-bell:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
            -webkit-transform: scale(1.05);
            transform: scale(1.05);
        }

        .notification-bell:active {
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
        }

        .notification-bell i {
            color: #a78bfa;
            font-size: 1.5rem;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            -webkit-border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            display: none;
            -webkit-align-items: center;
            align-items: center;
            -webkit-justify-content: center;
            justify-content: center;
            padding: 0 5px;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }

        .notification-badge.urgent {
            background: #ef4444;
            color: #fff;
            display: -webkit-flex;
            display: flex;
        }

        .notification-badge.important {
            background: #f59e0b;
            color: #fff;
            display: -webkit-flex;
            display: flex;
        }

        .notification-badge.reminder {
            background: #eab308;
            color: #1a1a2e;
            display: -webkit-flex;
            display: flex;
        }

        .notification-dropdown {
            position: fixed;
            -webkit-position: fixed;
            top: 85px;
            left: 20px;
            width: 320px;
            max-height: 70vh;
            background: rgba(15, 12, 41, 0.98);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            -webkit-border-radius: 16px;
            z-index: 9998;
            display: none;
            -webkit-flex-direction: column;
            flex-direction: column;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            -webkit-box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        .notification-dropdown.show {
            display: -webkit-flex;
            display: flex;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 18px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .notification-header h3 {
            color: #fff;
            font-size: 1rem;
            margin: 0;
        }

        .notification-header button {
            background: none;
            border: none;
            color: #a78bfa;
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
        }

        .notification-content {
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .notification-box {
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .notification-box.urgent {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .notification-box.important {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .notification-box.reminder {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
        }

        .notification-box-title {
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .notification-box.urgent .notification-box-title {
            color: #ef4444;
        }

        .notification-box.important .notification-box-title {
            color: #f59e0b;
        }

        .notification-box.reminder .notification-box-title {
            color: #eab308;
        }

        .notification-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .notification-delete {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 4px 8px;
            margin-left: 5px;
            border-radius: 4px;
            transition: all 0.15s ease;
            font-size: 0.8rem;
        }

        .notification-delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .notification-item-name {
            color: #e0e7ff;
            font-size: 0.85rem;
            flex: 1;
        }

        .notification-item-date {
            font-size: 0.75rem;
            white-space: nowrap;
            margin-right: 10px;
        }

        .notification-box.urgent .notification-item-date {
            color: #f87171;
        }

        .notification-box.important .notification-item-date {
            color: #fbbf24;
        }

        .notification-box.reminder .notification-item-date {
            color: #facc15;
        }

        .notification-empty {
            color: #6b7280;
            text-align: center;
            padding: 20px;
            font-size: 0.9rem;
        }

        /* Calendar Styles */
        .calendar-container {
            max-width: 100%;
            margin: 0 auto;
            margin-top: -55px;
            height: calc(100vh - 45px);
            display: flex;
            flex-direction: column;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .calendar-nav-btn {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #a78bfa;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            background: rgba(139, 92, 246, 0.4);
            color: #fff;
        }

        .calendar-month-year {
            font-size: 1.8rem;
            font-weight: 600;
            color: #fff;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: auto repeat(6, 1fr);
            gap: 8px;
            flex: 1;
        }

        /* Hide mobile list on desktop */
        .calendar-mobile-list {
            display: none;
        }

        .calendar-day-header {
            text-align: center;
            padding: 10px;
            font-weight: 600;
            color: #a78bfa;
            font-size: 1rem;
        }

        .calendar-day {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            min-height: 0;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }

        .calendar-day:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .calendar-day.other-month {
            opacity: 0.4;
        }

        .calendar-day.today {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }

        .calendar-day.has-homework {
            border-color: #ef4444 !important;
            background: rgba(239, 68, 68, 0.15);
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.3);
        }

        .calendar-day.has-homework .calendar-day-number {
            color: #ef4444;
            font-weight: 800;
        }

        .calendar-day.has-test {
            border-color: #f59e0b !important;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.25), rgba(251, 191, 36, 0.15));
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.5), 0 0 40px rgba(251, 191, 36, 0.3), inset 0 0 15px rgba(245, 158, 11, 0.1);
            animation: testGlow 2s ease-in-out infinite;
        }

        @keyframes testGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(245, 158, 11, 0.5), 0 0 40px rgba(251, 191, 36, 0.3);
            }
            50% {
                box-shadow: 0 0 30px rgba(245, 158, 11, 0.7), 0 0 60px rgba(251, 191, 36, 0.5);
            }
        }

        .calendar-day.has-test .calendar-day-number {
            color: #f59e0b;
            font-weight: 900;
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        .calendar-day-number {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 4px;
            color: #fff;
        }

        .calendar-day.today .calendar-day-number {
            color: #10b981;
            font-weight: 800;
        }

        .calendar-event {
            font-size: 0.7rem;
            padding: 3px 5px;
            border-radius: 4px;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-event.course {
            background: rgba(34, 211, 238, 0.3);
            color: #22d3ee;
        }

        .calendar-event.homework {
            background: rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }

        .calendar-event.test {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.4), rgba(251, 191, 36, 0.3));
            color: #f59e0b;
            font-weight: 600;
            text-shadow: 0 0 5px rgba(245, 158, 11, 0.3);
        }

        /* Calendar Modal */
        .calendar-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .calendar-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .calendar-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #fff;
        }

        .calendar-modal-close {
            background: none;
            border: none;
            color: #a78bfa;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .calendar-form-group {
            margin-bottom: 15px;
        }

        .calendar-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #a78bfa;
            font-size: 0.9rem;
        }

        .calendar-form-group input,
        .calendar-form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            font-family: inherit;
        }

        .calendar-form-group select option {
            background: #1a1a2e;
            color: #fff;
        }

        .calendar-add-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
        }

        .calendar-events-list {
            margin-top: 15px;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            padding-top: 15px;
        }

        .calendar-event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .calendar-event-item .event-info {
            flex: 1;
        }

        .calendar-event-item .event-name {
            font-weight: 500;
            color: #fff;
        }

        .calendar-event-item .event-type {
            font-size: 0.8rem;
            color: #a78bfa;
        }

        .calendar-event-actions {
            display: flex;
            gap: 8px;
        }

        .calendar-event-edit {
            background: rgba(251, 191, 36, 0.2);
            border: none;
            color: #fbbf24;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-event-edit:hover {
            background: rgba(251, 191, 36, 0.4);
        }

        .calendar-event-delete {
            background: rgba(239, 68, 68, 0.2);
            border: none;
            color: #ef4444;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-event-delete:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        /* Delete Confirmation Modal */
        .delete-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .delete-modal {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d1f3d 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(239, 68, 68, 0.2);
            animation: modalPop 0.1s ease-out;
        }

        @keyframes modalPop {
            from {
                transform: scale(0.95);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .delete-modal-icon {
            width: 70px;
            height: 70px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .delete-modal-icon i {
            font-size: 2rem;
            color: #ef4444;
        }

        .delete-modal-title {
            color: #fff;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .delete-modal-text {
            color: #a78bfa;
            font-size: 1rem;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .delete-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .delete-modal-btn {
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .delete-modal-cancel {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .delete-modal-cancel:hover {
            background: rgba(139, 92, 246, 0.4);
        }

        .delete-modal-confirm {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
        }

        .delete-modal-confirm:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: scale(1.05);
        }

        /* Responsive - Mobile phones and tablets */
        @media screen and (max-width: 1400px) {
            /* iOS fixed positioning fix */
            html {
                height: 100%;
                overflow: hidden;
            }
            body {
                height: 100%;
                overflow: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Force sidebar to bottom - fixed position for iOS/Safari */
            nav.sidebar {
                width: 100% !important;
                height: auto !important;
                position: fixed !important;
                -webkit-position: fixed !important;
                bottom: 0 !important;
                top: unset !important;
                right: 0 !important;
                left: 0 !important;
                border-left: none !important;
                border-top: 2px solid rgba(139, 92, 246, 0.4);
                display: flex !important;
                flex-direction: row !important;
                align-items: center;
                justify-content: space-around;
                padding: 12px 0;
                padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
                z-index: 9999;
                background: rgba(15, 12, 41, 0.98);
                transform: translateZ(0) !important;
                -webkit-transform: translateZ(0) !important;
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
            }
            .sidebar-header {
                padding: 0;
                border-bottom: none;
                margin-bottom: 0;
            }
            .sidebar-header { display: none !important; }
            .logo { display: none !important; }
            .menu-item {
                padding: 25px 35px;
                border-right: none !important;
                border-bottom: 3px solid transparent;
                border-top: none !important;
                border-left: none !important;
                font-size: 1.5rem;
                display: flex !important;
                align-items: center;
                justify-content: center;
                min-width: 90px;
                min-height: 70px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                cursor: pointer;
                background: transparent !important;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            .menu-item * {
                pointer-events: none;
            }
            .menu-item:focus {
                outline: none;
            }
            .menu-item i {
                font-size: 1.5rem;
            }
            .menu-item.active {
                border-bottom-color: #ec4899 !important;
                border-right-color: transparent !important;
            }
            .menu-item span { display: none !important; }
            .logout-btn {
                position: static !important;
                margin: 0 !important;
                padding: 12px 20px;
                font-size: 1.2rem;
                bottom: auto !important;
            }
            .logout-btn span { display: none !important; }


            /* Notification bell mobile */
            .notification-bell {
                top: 12px;
                left: 12px;
                width: 48px;
                height: 48px;
                border-radius: 12px;
                -webkit-border-radius: 12px;
            }
            .notification-bell i {
                font-size: 1.3rem;
            }
            .notification-badge {
                top: -4px;
                right: -4px;
                min-width: 18px;
                height: 18px;
                font-size: 0.7rem;
            }
            .notification-dropdown {
                top: 70px;
                left: 12px;
                right: 12px;
                width: auto;
                max-width: calc(100vw - 24px);
                max-height: 60vh;
            }
            .notification-header {
                padding: 12px 15px;
            }
            .notification-content {
                padding: 12px;
                gap: 10px;
            }
            .notification-box {
                padding: 10px;
            }
            .notification-item {
                padding: 8px;
            }
            .notification-item-name {
                font-size: 0.8rem;
            }
            .notification-item-date {
                font-size: 0.7rem;
            }

            .main {
                margin-right: 0 !important;
                padding: 15px 12px 12px 12px !important;
                width: 100% !important;
                min-height: 100vh;
                padding-bottom: 160px !important;
                box-sizing: border-box;
            }

            /* Course home page */
            .page-title {
                font-size: 1.6rem;
                margin-bottom: 20px;
                padding-top: 0;
                text-align: center;
            }

            .course-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px;
                padding: 0 10px;
            }
            .course-card {
                padding: 15px;
                border-radius: 16px;
                aspect-ratio: 1 / 1 !important;
            }
            .course-card-icon { width: 45px; height: 45px; font-size: 20px; margin-bottom: 10px; }
            .course-card-name { font-size: 0.85rem; text-align: center; }
            .course-card-count { font-size: 0.75rem; margin-top: 6px; }

            /* Inside course - back button */
            .back-btn {
                position: sticky !important;
                top: 10px !important;
                right: auto !important;
                left: 10px !important;
                padding: 10px 16px;
                font-size: 0.9rem;
                z-index: 500;
                margin-bottom: 15px;
                display: inline-flex;
                background: rgba(15, 12, 41, 0.95) !important;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            }

            /* Categories - WRAP instead of scroll */
            .category-bar {
                flex-wrap: wrap !important;
                overflow-x: visible !important;
                overflow: visible !important;
                padding: 8px;
                gap: 8px;
                margin-bottom: 15px;
                justify-content: center;
            }
            .category-tab {
                padding: 8px 12px;
                font-size: 0.8rem;
                white-space: nowrap;
                flex-shrink: 0;
            }
            .category-tab i { display: none !important; }
            .category-tab .count {
                padding: 2px 6px;
                font-size: 0.7rem;
                margin-right: 5px;
            }

            .items-header {
                margin-bottom: 15px;
                flex-direction: row;
                gap: 10px;
            }
            .items-title { font-size: 1.2rem; }
            .add-btn { padding: 10px 16px; font-size: 0.9rem; }

            /* Item cards */
            .items-grid {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }
            .item-card {
                padding: 15px;
                border-radius: 14px;
            }
            .item-header {
                flex-direction: column;
                gap: 10px;
            }
            .item-checkbox { width: 26px; height: 26px; }
            .item-checkbox i { font-size: 12px; }
            .item-title { font-size: 1.1rem; text-align: center; }
            .item-meta {
                font-size: 0.85rem;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            .item-file-badge { font-size: 0.8rem; padding: 4px 10px; }
            .uploaders-list { margin-top: 10px; padding-top: 10px; }
            .uploader-line { font-size: 0.85rem; justify-content: center; padding: 4px 0; }
            .uploader-count { font-size: 0.75rem; padding: 3px 8px; }

            .item-actions {
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                gap: 8px;
                justify-content: center;
                margin-top: 12px;
                padding-top: 12px;
            }
            .item-action-btn {
                padding: 10px 14px;
                font-size: 0.85rem;
                flex: 1;
                justify-content: center;
                border-radius: 10px;
                min-width: auto !important;
            }
            .item-action-btn i { margin-left: 5px; }

            /* Item detail page */
            .item-detail {
                padding: 18px 15px 30px 15px;
                border-radius: 16px;
                margin-top: 15px;
            }
            .item-detail-header {
                gap: 12px;
                margin-bottom: 20px;
                padding-bottom: 18px;
                flex-direction: column;
            }
            .item-detail-icon { width: 50px; height: 50px; font-size: 20px; }
            .item-detail-title { font-size: 1.3rem; }
            .item-detail-section { margin-bottom: 20px; }
            .item-detail-section h4 { font-size: 1.05rem; margin-bottom: 10px; }
            .item-detail-info { padding: 12px 15px; font-size: 0.95rem; }

            .detail-actions {
                flex-direction: column;
                gap: 10px;
                margin-top: 25px;
                padding-top: 20px;
            }
            .detail-btn {
                padding: 14px 20px;
                font-size: 1rem;
            }
            .detail-btn-return {
                padding: 12px 18px;
                font-size: 0.95rem;
            }

            /* Files section */
            .file-preview {
                padding: 15px;
                margin-bottom: 10px;
            }
            .file-preview i { font-size: 2rem; margin-bottom: 10px; }
            .file-preview h4 { font-size: 0.95rem; word-break: break-all; }
            .file-preview p { font-size: 0.85rem; }
            .file-preview-actions {
                flex-direction: column;
                gap: 8px;
            }
            .file-preview-actions .detail-btn {
                width: 100%;
                padding: 12px 16px;
                font-size: 0.95rem;
            }

            .no-file { padding: 25px; }
            .no-file i { font-size: 2rem; margin-bottom: 10px; }
            .no-file h4 { font-size: 1.05rem; }
            .no-file p { font-size: 0.9rem; }

            /* Notes section */
            .notes-section { padding: 10px 12px; }
            .note-item { padding: 12px; margin-bottom: 8px; }
            .note-header { font-size: 0.8rem; flex-wrap: wrap; gap: 6px; }
            .note-text { font-size: 0.9rem; line-height: 1.5; }
            .add-note-form textarea {
                min-height: 50px;
                font-size: 0.95rem;
                padding: 10px;
            }
            .add-note-form .detail-btn {
                padding: 12px 18px;
                font-size: 0.95rem;
            }

            /* Login screen mobile */
            .login-screen { padding: 20px; }
            .login-box {
                padding: 25px 20px;
                margin: 0;
                max-width: 100%;
            }
            .login-logo { gap: 12px; margin-bottom: 25px; }
            .login-logo-icon { width: 55px; height: 55px; font-size: 22px; }
            .login-logo h1 { font-size: 1.7rem; }
            .login-title { font-size: 1rem; margin-bottom: 20px; }
            .login-form .form-group { margin-bottom: 18px; }
            .login-form .form-group label { font-size: 0.95rem; margin-bottom: 8px; }
            .login-form .form-group input { padding: 14px 16px; font-size: 1rem; border-radius: 12px; }
            .login-btn { padding: 16px; font-size: 1.1rem; border-radius: 12px; }
            .login-error { padding: 12px; font-size: 0.95rem; }

            /* Modal mobile */
            .modal-overlay { padding: 15px; }
            .modal {
                max-width: 100%;
                margin: 0;
                border-radius: 16px;
            }
            .modal-header { padding: 16px 18px; }
            .modal-header h3 { font-size: 1.05rem; }
            .modal-close { width: 32px; height: 32px; font-size: 1rem; }
            .modal-body { padding: 16px 18px; }
            .form-group { margin-bottom: 16px; }
            .form-group label { font-size: 0.95rem; }
            .form-group input { padding: 12px 14px; font-size: 1rem; }
            .modal-footer { padding: 14px 18px; }
            .btn { padding: 12px 16px; font-size: 0.95rem; }

            .file-drop { padding: 20px; }
            .file-drop i { font-size: 1.6rem; margin-bottom: 8px; }
            .file-drop h4 { font-size: 0.95rem; }
            .file-drop p { font-size: 0.85rem; }

            .file-attached { padding: 10px; }
            .file-attached i { font-size: 1.3rem; }
            .file-attached-info h4 { font-size: 0.95rem; }
            .file-attached-info p { font-size: 0.8rem; }

            /* Toast mobile */
            .toast {
                bottom: 100px;
                padding: 14px 20px;
                font-size: 0.95rem;
                max-width: 90%;
            }
            .toast i { font-size: 1.1rem; }

            /* Empty state mobile */
            .empty-state { padding: 30px 15px; }
            .empty-state i { font-size: 2.5rem; margin-bottom: 12px; }
            .empty-state h3 { font-size: 1.1rem; }
            .empty-state p { font-size: 0.9rem; }

            /* Calendar mobile - list view */
            .calendar-container {
                padding: 0 10px !important;
                width: 100% !important;
                max-width: 100vw !important;
                box-sizing: border-box !important;
                margin-top: 10px !important;
            }
            .calendar-header {
                margin-bottom: 15px;
                justify-content: center;
            }
            .calendar-nav {
                justify-content: center;
                gap: 15px;
            }
            .calendar-nav-btn {
                padding: 10px 18px;
                font-size: 1rem;
                border-radius: 12px;
            }
            .calendar-month-year {
                font-size: 1.2rem;
                min-width: 130px;
                text-align: center;
            }
            /* Hide grid calendar on mobile */
            .calendar-grid {
                display: none !important;
            }
            /* Show mobile list view */
            .calendar-mobile-list {
                display: block !important;
                padding-bottom: 100px;
                margin-bottom: 80px;
            }
            .calendar-mobile-day {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(139, 92, 246, 0.2);
                border-radius: 12px;
                margin-bottom: 10px;
                overflow: hidden;
            }
            .calendar-mobile-day.today {
                border-color: #10b981;
                background: rgba(16, 185, 129, 0.1);
                box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
            }
            .calendar-mobile-day.has-homework {
                border-color: #ef4444 !important;
                background: rgba(239, 68, 68, 0.1);
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
            }
            .calendar-mobile-day.has-homework .calendar-mobile-day-header {
                background: rgba(239, 68, 68, 0.2);
                color: #ef4444;
            }
            .calendar-mobile-day.has-test {
                border-color: #f59e0b !important;
                background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(251, 191, 36, 0.1));
                box-shadow: 0 0 15px rgba(245, 158, 11, 0.4), 0 0 30px rgba(251, 191, 36, 0.2);
                animation: testGlow 2s ease-in-out infinite;
            }
            .calendar-mobile-day.has-test .calendar-mobile-day-header {
                background: rgba(245, 158, 11, 0.25);
                color: #f59e0b;
                text-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
            }
            .calendar-mobile-day-header {
                background: rgba(139, 92, 246, 0.15);
                padding: 10px 12px;
                font-weight: 600;
                color: #a78bfa;
                display: flex;
                justify-content: space-between;
            }
            .calendar-mobile-day.today .calendar-mobile-day-header {
                background: rgba(16, 185, 129, 0.2);
                color: #10b981;
            }
            .calendar-mobile-events {
                padding: 8px;
            }
            .calendar-mobile-event {
                padding: 8px 10px;
                margin-bottom: 6px;
                border-radius: 8px;
                font-size: 0.85rem;
                color: #fff;
            }
            .calendar-mobile-event:last-child {
                margin-bottom: 0;
            }
            .calendar-mobile-event.course {
                background: rgba(34, 211, 238, 0.2);
                border-right: 3px solid #22d3ee;
            }
            .calendar-mobile-event.homework {
                background: rgba(251, 191, 36, 0.2);
                border-right: 3px solid #fbbf24;
            }
            .calendar-mobile-event.test {
                background: linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(251, 191, 36, 0.2));
                border-right: 3px solid #f59e0b;
                font-weight: 600;
            }
            .calendar-mobile-no-events {
                color: #666;
                font-size: 0.85rem;
                text-align: center;
                padding: 10px;
            }
            .calendar-modal { padding: 20px; max-width: 95%; }
            .calendar-modal-title { font-size: 1.1rem; }
            .calendar-form-group input,
            .calendar-form-group select { padding: 12px; font-size: 1rem; }
            .calendar-add-btn { padding: 12px; font-size: 1rem; }

            /* Prevent horizontal scroll and fix iOS scrolling */
            html, body {
                overflow-x: hidden !important;
                max-width: 100vw !important;
                -webkit-overflow-scrolling: touch;
            }

            /* Ensure main content scrolls, not the whole page */
            .main {
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">
                <div class="login-logo-icon"><i class="fas fa-graduation-cap"></i></div>
                <h1>StudyHub</h1>
            </div>
            <p class="login-title">התחבר כדי לגשת לחומרי הלימוד</p>
            <div class="login-error" id="loginError">שם משתמש או סיסמה שגויים</div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>שם משתמש</label>
                    <input type="text" id="loginUsername" placeholder="הכנס שם משתמש" required>
                </div>
                <div class="form-group">
                    <label>סיסמה</label>
                    <input type="password" id="loginPassword" placeholder="הכנס סיסמה" required>
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    התחבר
                </button>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="logo" onclick="showHomePage()" style="cursor: pointer;">
                <div class="logo-icon"><i class="fas fa-graduation-cap"></i></div>
                <h1>StudyHub</h1>
            </div>
        </div>

        <button type="button" class="menu-item active" id="menuHome">
            <i class="fas fa-home"></i>
            <span>דף בית</span>
        </button>

        <button type="button" class="menu-item" id="menuCourses">
            <i class="fas fa-book"></i>
            <span>קורסים</span>
        </button>

        <button type="button" class="menu-item" id="menuCalendar">
            <i class="fas fa-calendar-alt"></i>
            <span>לוח שנה</span>
        </button>

        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>התנתק</span>
        </button>
    </nav>

    <!-- Notification Bell -->
    <div class="notification-bell" id="notificationBell" onclick="toggleNotifications()">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notificationBadge"></span>
    </div>

    <!-- Notification Dropdown -->
    <div class="notification-dropdown" id="notificationDropdown">
        <div class="notification-header">
            <h3>התראות</h3>
            <button onclick="toggleNotifications()"><i class="fas fa-times"></i></button>
        </div>
        <div class="notification-content" id="notificationContent">
            <!-- Boxes will be rendered here -->
        </div>
    </div>

    <!-- Main Content -->
    <main class="main" id="mainContent"></main>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage"></span>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">הוסף פריט</h3>
                <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>שם הפריט</label>
                    <input type="text" id="itemName" placeholder="לדוגמה: שיעור 1 - מבוא">
                </div>
                <div class="form-group">
                    <label>שם המעלה</label>
                    <input type="text" id="uploaderName" placeholder="השם שלך">
                </div>
                <div class="form-group">
                    <label>קובץ מצורף</label>
                    <div id="fileZone"></div>
                    <input type="file" id="fileInput" style="display:none" onchange="handleFileSelect(this)">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">ביטול</button>
                <button class="btn btn-primary" onclick="saveItem()">
                    <i class="fas fa-check"></i> שמור
                </button>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div class="calendar-modal-overlay" id="calendarModal" onclick="if(event.target === this) closeCalendarModal()">
        <div class="calendar-modal">
            <div class="calendar-modal-header">
                <h3 class="calendar-modal-title" id="calendarModalTitle">הוסף אירוע</h3>
                <button class="calendar-modal-close" onclick="closeCalendarModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="calendar-form-group">
                <label>שם האירוע</label>
                <input type="text" id="eventName" placeholder="לדוגמה: שיעור מתמטיקה">
            </div>
            <div class="calendar-form-group">
                <label>סוג האירוע</label>
                <select id="eventType">
                    <option value="course">קורס / שיעור</option>
                    <option value="homework">מטלה / שיעורי בית</option>
                    <option value="test">מבחן / בוחן</option>
                </select>
            </div>
            <button id="calendarAddBtn" class="calendar-add-btn" onclick="saveCalendarEvent()">
                <i class="fas fa-plus"></i> הוסף
            </button>
            <div class="calendar-events-list" id="calendarEventsList"></div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="delete-modal-overlay" id="deleteModal">
        <div class="delete-modal">
            <div class="delete-modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="delete-modal-title">האם אתה בטוח?</h3>
            <p class="delete-modal-text" id="deleteModalText">האם למחוק את הפריט הזה?</p>
            <div class="delete-modal-buttons">
                <button class="delete-modal-btn delete-modal-cancel" onclick="closeDeleteModal()">
                    <i class="fas fa-times"></i> ביטול
                </button>
                <button class="delete-modal-btn delete-modal-confirm" id="deleteModalConfirm">
                    <i class="fas fa-trash"></i> מחק
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== LOGIN SYSTEM ==========
        // Set your username and password here
        const VALID_USERS = [
            { username: 'chris', password: '1234' },
            { username: 'admin', password: 'admin123' },
            { username: 'eden', password: '1234' },
            { username: 'idan', password: '1234' },
            { username: 'michal', password: '1234' },
            { username: 'talab', password: '1234' }
        ];

        let isLoggedIn = false;

        function checkLogin() {
            const session = sessionStorage.getItem('studyhub_logged_in');
            if (session === 'true') {
                isLoggedIn = true;
                document.getElementById('loginScreen').style.display = 'none';
                return true;
            }
            document.getElementById('loginScreen').style.display = 'flex';
            return false;
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            const validUser = VALID_USERS.find(u =>
                u.username.toLowerCase() === username.toLowerCase() && u.password === password
            );

            if (validUser) {
                isLoggedIn = true;
                sessionStorage.setItem('studyhub_logged_in', 'true');
                sessionStorage.setItem('studyhub_current_user', validUser.username);
                localStorage.setItem('studyhub_username', validUser.username);
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('loginError').classList.remove('show');
                showToast('ברוך הבא, ' + validUser.username + '!');
            } else {
                document.getElementById('loginError').classList.add('show');
                document.getElementById('loginPassword').value = '';
            }
        }

        function logout() {
            if (confirm('האם אתה בטוח שברצונך להתנתק?')) {
                isLoggedIn = false;
                sessionStorage.removeItem('studyhub_logged_in');
                sessionStorage.removeItem('studyhub_current_user');
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                showToast('התנתקת בהצלחה');
            }
        }

        // ========== NOTIFICATION SYSTEM ==========
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.classList.toggle('show');
            if (dropdown.classList.contains('show')) {
                renderNotifications();
                // Clear the badge when opened and mark as seen today
                const badge = document.getElementById('notificationBadge');
                badge.style.display = 'none';
                badge.textContent = '';
                markNotificationsSeen();
            }
        }

        // Cloud notification data per user
        // Structure: { username: { seenNotifications: ["2025-12-12_מבחן"], dismissed: {} } }
        let cloudNotifications = {};

        // Mark current notifications as seen by this user
        async function markNotificationsSeen() {
            const username = localStorage.getItem('studyhub_username') || 'guest';

            // Get all current notification IDs
            const { urgent, important, reminder } = getAllNotifications();
            const allNotifications = [...urgent, ...important, ...reminder];

            // Update local - add all current notifications to seenNotifications
            if (!cloudNotifications[username]) cloudNotifications[username] = { seenNotifications: [], dismissed: {} };
            if (!cloudNotifications[username].seenNotifications) cloudNotifications[username].seenNotifications = [];

            allNotifications.forEach(item => {
                const notificationId = `${item.date}_${item.name}`;
                if (!cloudNotifications[username].seenNotifications.includes(notificationId)) {
                    cloudNotifications[username].seenNotifications.push(notificationId);
                }
            });

            // Save to cloud
            await saveNotificationsToCloud();
        }

        // Get notifications that user hasn't seen yet
        function getUnseenNotificationIds() {
            const username = localStorage.getItem('studyhub_username') || 'guest';
            const userData = cloudNotifications[username];
            if (!userData || !userData.seenNotifications) return new Set();
            return new Set(userData.seenNotifications);
        }

        // Get dismissed notifications for current user
        // Dismissed notifications stay hidden until the event date passes
        function getDismissedNotifications() {
            const username = localStorage.getItem('studyhub_username') || 'guest';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const userData = cloudNotifications[username];
            if (!userData || !userData.dismissed) return {};

            const cleaned = {};
            for (const [notificationId, dismissData] of Object.entries(userData.dismissed)) {
                const eventDate = notificationId.split('_')[0];
                const eventDateObj = new Date(eventDate);
                eventDateObj.setHours(0, 0, 0, 0);

                // If event date is in the past, don't keep it (event already passed)
                if (eventDateObj < today) {
                    continue;
                }

                // Keep dismissed notification hidden until event date passes
                cleaned[notificationId] = dismissData;
            }

            return cleaned;
        }

        // Dismiss a notification for current user (stays hidden until event date passes)
        async function dismissNotification(date, name) {
            const username = localStorage.getItem('studyhub_username') || 'guest';
            const notificationId = `${date}_${name}`;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];

            // Update local
            if (!cloudNotifications[username]) cloudNotifications[username] = { seenNotifications: [], dismissed: {} };
            if (!cloudNotifications[username].dismissed) cloudNotifications[username].dismissed = {};

            cloudNotifications[username].dismissed[notificationId] = {
                dismissedOn: todayStr
            };

            // Save to cloud
            await saveNotificationsToCloud();
            renderNotifications();
        }

        // Save notifications to cloud
        async function saveNotificationsToCloud() {
            const username = localStorage.getItem('studyhub_username') || 'guest';
            try {
                // Get current cloud data
                const getResponse = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                let cloudJson = { appdata: {}, calendar: {}, notifications: {} };
                if (getResponse.ok) {
                    const gist = await getResponse.json();
                    const content = gist.files[GIST_FILENAME]?.content;
                    if (content) cloudJson = JSON.parse(content);
                }

                // ONLY update current user's notification data (don't overwrite other users)
                if (!cloudJson.notifications) cloudJson.notifications = {};
                cloudJson.notifications[username] = cloudNotifications[username];

                // Save back to cloud
                await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: { [GIST_FILENAME]: { content: JSON.stringify(cloudJson) } }
                    })
                });
                console.log('🔔 Notifications synced to cloud');
            } catch (error) {
                console.log('Notification sync failed:', error);
            }
        }

        // Load notifications from cloud
        async function loadNotificationsFromCloud() {
            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const gist = await response.json();
                    const content = gist.files[GIST_FILENAME]?.content;
                    if (content) {
                        const cloudJson = JSON.parse(content);
                        if (cloudJson.notifications) {
                            cloudNotifications = cloudJson.notifications;
                        }
                    }
                }
            } catch (error) {
                console.log('Failed to load notifications:', error);
            }
        }

        // Get ALL notifications (regardless of seen status) - used for marking as seen
        function getAllNotifications() {
            const now = new Date();
            now.setHours(0, 0, 0, 0);

            const urgent = [];    // דחוף - today or overdue
            const important = []; // חשוב - tomorrow
            const reminder = [];  // תזכורת - in 3 days

            // Get dismissed notifications for this user (auto-cleaned)
            const dismissed = getDismissedNotifications();

            // Loop through all dates in calendarEvents object
            for (const [dateStr, events] of Object.entries(calendarEvents)) {
                events.forEach(event => {
                    // Only check tests and assignments/homework
                    if (event.type !== 'test' && event.type !== 'assignment' && event.type !== 'homework') {
                        return;
                    }

                    // Check if this notification was dismissed today
                    const notificationId = `${dateStr}_${event.name}`;
                    if (dismissed[notificationId]) {
                        return;
                    }

                    const eventDate = new Date(dateStr);
                    eventDate.setHours(0, 0, 0, 0);

                    const diffDays = Math.floor((eventDate - now) / (1000 * 60 * 60 * 24));

                    const item = {
                        name: event.name,
                        date: dateStr,
                        type: event.type,
                        diffDays: diffDays
                    };

                    if (diffDays < 0) {
                        // Overdue - דחוף
                        item.label = 'עבר התאריך!';
                        urgent.push(item);
                    } else if (diffDays === 0) {
                        // Today - דחוף
                        item.label = 'היום!';
                        urgent.push(item);
                    } else if (diffDays === 1) {
                        // Tomorrow - חשוב
                        item.label = 'מחר';
                        important.push(item);
                    } else if (diffDays <= 3) {
                        // In 2-3 days - תזכורת
                        item.label = `בעוד ${diffDays} ימים`;
                        reminder.push(item);
                    }
                });
            }

            // Sort by date
            urgent.sort((a, b) => a.diffDays - b.diffDays);
            important.sort((a, b) => a.diffDays - b.diffDays);
            reminder.sort((a, b) => a.diffDays - b.diffDays);

            return { urgent, important, reminder };
        }

        // Get only UNSEEN notifications for badge count
        function getUnseenNotifications() {
            const { urgent, important, reminder } = getAllNotifications();
            const seenIds = getUnseenNotificationIds(); // This returns the SET of seen IDs

            // Filter to only unseen notifications (for badge count)
            const filterUnseen = (items) => items.filter(item => {
                const notificationId = `${item.date}_${item.name}`;
                return !seenIds.has(notificationId);
            });

            return {
                urgent: filterUnseen(urgent),
                important: filterUnseen(important),
                reminder: filterUnseen(reminder)
            };
        }

        // Get ALL notifications for display in dropdown (until dismissed or date passed)
        function getNotifications() {
            return getAllNotifications();
        }

        function renderNotifications() {
            const { urgent, important, reminder } = getNotifications();
            const container = document.getElementById('notificationContent');

            const totalCount = urgent.length + important.length + reminder.length;

            if (totalCount === 0) {
                container.innerHTML = '<div class="notification-empty"><i class="fas fa-check-circle" style="font-size: 2rem; color: #10b981; margin-bottom: 10px; display: block;"></i>אין התראות חדשות</div>';
                updateNotificationBadge(0, null);
                return;
            }

            let html = '';

            // דחוף box
            if (urgent.length > 0) {
                html += `
                    <div class="notification-box urgent">
                        <div class="notification-box-title">
                            <i class="fas fa-exclamation-circle"></i>
                            דחוף (${urgent.length})
                        </div>
                        ${urgent.map(item => `
                            <div class="notification-item">
                                <button class="notification-delete" onclick="dismissNotification('${item.date}', '${item.name.replace(/'/g, "\\'")}')"><i class="fas fa-times"></i></button>
                                <span class="notification-item-name">
                                    <i class="fas fa-${item.type === 'test' ? 'file-alt' : 'tasks'}"></i>
                                    ${item.name}
                                </span>
                                <span class="notification-item-date">${item.label}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // חשוב box
            if (important.length > 0) {
                html += `
                    <div class="notification-box important">
                        <div class="notification-box-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            חשוב (${important.length})
                        </div>
                        ${important.map(item => `
                            <div class="notification-item">
                                <button class="notification-delete" onclick="dismissNotification('${item.date}', '${item.name.replace(/'/g, "\\'")}')"><i class="fas fa-times"></i></button>
                                <span class="notification-item-name">
                                    <i class="fas fa-${item.type === 'test' ? 'file-alt' : 'tasks'}"></i>
                                    ${item.name}
                                </span>
                                <span class="notification-item-date">${item.label}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // תזכורת box
            if (reminder.length > 0) {
                html += `
                    <div class="notification-box reminder">
                        <div class="notification-box-title">
                            <i class="fas fa-bell"></i>
                            תזכורת (${reminder.length})
                        </div>
                        ${reminder.map(item => `
                            <div class="notification-item">
                                <button class="notification-delete" onclick="dismissNotification('${item.date}', '${item.name.replace(/'/g, "\\'")}')"><i class="fas fa-times"></i></button>
                                <span class="notification-item-name">
                                    <i class="fas fa-${item.type === 'test' ? 'file-alt' : 'tasks'}"></i>
                                    ${item.name}
                                </span>
                                <span class="notification-item-date">${item.label}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            container.innerHTML = html;

            // Update badge based on UNSEEN notifications only
            const unseen = getUnseenNotifications();
            const unseenCount = unseen.urgent.length + unseen.important.length + unseen.reminder.length;
            if (unseen.urgent.length > 0) {
                updateNotificationBadge(unseenCount, 'urgent');
            } else if (unseen.important.length > 0) {
                updateNotificationBadge(unseenCount, 'important');
            } else if (unseenCount > 0) {
                updateNotificationBadge(unseenCount, 'reminder');
            } else {
                updateNotificationBadge(0, null);
            }
        }

        function updateNotificationBadge(count, priority) {
            const badge = document.getElementById('notificationBadge');
            badge.className = 'notification-badge';

            // Don't show badge if no unseen notifications
            if (count === 0 || !priority) {
                badge.style.display = 'none';
                badge.textContent = '';
            } else {
                badge.classList.add(priority);
                badge.textContent = count;
            }
        }

        // Update notifications periodically
        async function initNotifications() {
            // Load notification data from cloud first
            await loadNotificationsFromCloud();
            renderNotifications();
            // Update every minute
            setInterval(async () => {
                const dropdown = document.getElementById('notificationDropdown');
                if (!dropdown.classList.contains('show')) {
                    // Reload from cloud to get latest dismissals
                    await loadNotificationsFromCloud();
                    // Just update the badge based on UNSEEN notifications
                    const unseen = getUnseenNotifications();
                    const unseenCount = unseen.urgent.length + unseen.important.length + unseen.reminder.length;
                    if (unseen.urgent.length > 0) {
                        updateNotificationBadge(unseenCount, 'urgent');
                    } else if (unseen.important.length > 0) {
                        updateNotificationBadge(unseenCount, 'important');
                    } else if (unseenCount > 0) {
                        updateNotificationBadge(unseenCount, 'reminder');
                    } else {
                        updateNotificationBadge(0, null);
                    }
                }
            }, 60000);
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('notificationDropdown');
            const bell = document.getElementById('notificationBell');
            if (dropdown && bell && !dropdown.contains(e.target) && !bell.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // ========== DATA ==========
        const COURSES = [
            { id: 1, name: 'מתמטיקה 2', icon: 'fa-square-root-alt', color: '#818cf8' },
            { id: 2, name: 'מתמטיקה בדידה', icon: 'fa-project-diagram', color: '#f472b6' },
            { id: 3, name: 'בסיסי נתונים', icon: 'fa-database', color: '#2dd4bf' },
            { id: 4, name: 'מבני נתונים', icon: 'fa-sitemap', color: '#facc15' },
            { id: 5, name: 'אבטחת מידע', icon: 'fa-shield-alt', color: '#38bdf8' },
            { id: 6, name: 'אנגלית ב', icon: 'fa-language', color: '#fb923c' }
        ];

        const CATEGORIES = [
            { id: 'presentations', name: 'מצגות', icon: 'fa-desktop', color: '#f472b6' },
            { id: 'summariesCourse', name: 'סיכומים לקורס', icon: 'fa-file-alt', color: '#818cf8' },
            { id: 'summariesPractice', name: 'סיכומים לתרגול', icon: 'fa-edit', color: '#a78bfa' },
            { id: 'homework', name: 'שיעורי בית', icon: 'fa-pencil-alt', color: '#facc15' },
            { id: 'hwSolutions', name: 'פתרונות ש"ב', icon: 'fa-check', color: '#4ade80' },
            { id: 'assignments', name: 'עבודות להגשה', icon: 'fa-clipboard-list', color: '#fb923c' },
            { id: 'assignmentSolutions', name: 'פתרונות עבודות', icon: 'fa-check-double', color: '#2dd4bf' },
            { id: 'formulas', name: 'דף נוסחאות', icon: 'fa-calculator', color: '#38bdf8' }
        ];

        // ========== CLOUD CONFIG ==========
        const GIST_ID = '70ade01d4645cc8013a741b74d83561c';
        const GIST_FILENAME = 'studyhub_cloud.json';
        // Token parts (split to avoid detection)
        const _t = ['gho','_dADfnYflfNde','RK5d2E8O2i7H','5oof27064jOs'];
        const GITHUB_TOKEN = _t.join('');

        // Cloudinary config for file uploads (up to 10MB)
        const CLOUDINARY_CLOUD_NAME = 'dk1p4fbxr';
        const CLOUDINARY_UPLOAD_PRESET = 'studyhub_unsigned';

        // Upload file to Cloudinary
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            formData.append('folder', 'studyhub');

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`, {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    const data = await response.json();
                    return data.secure_url;
                }
            } catch(e) {
                console.log('Cloudinary upload failed:', e);
            }
            return null;
        }

        // ========== STATE ==========
        let appData = {};
        let currentCourse = null;
        let currentCategory = null;
        let currentItemIndex = null;
        let selectedFile = null;
        let viewingItem = null;

        // ========== INIT ==========
        function init() {
            checkLogin();
            loadData();

            // Initialize calendar events before rendering any page
            mergeAllEvents();

            // Setup menu button event listeners for cross-browser compatibility
            document.getElementById('menuHome').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                showHomePage();
            });
            document.getElementById('menuCourses').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                goHome();
            });
            document.getElementById('menuCalendar').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                showCalendar();
            });

            restorePageState();

            // Initialize notifications
            initNotifications();

            // Auto-sync every 10 seconds
            setInterval(() => {
                syncFromCloud();
                loadCalendarEvents();
            }, 10000);
        }

        // Save current page state to localStorage
        function savePageState() {
            let page = 'homepage';
            if (currentCourse) {
                page = viewingItem !== null ? 'item' : 'course';
            } else if (document.getElementById('menuCalendar').classList.contains('active')) {
                page = 'calendar';
            } else if (document.getElementById('menuCourses').classList.contains('active')) {
                page = 'courses';
            }
            const state = {
                page: page,
                course: currentCourse,
                category: currentCategory,
                item: viewingItem
            };
            localStorage.setItem('studyhub_page_state', JSON.stringify(state));
        }

        // Restore page state from localStorage
        function restorePageState() {
            try {
                const saved = localStorage.getItem('studyhub_page_state');
                if (saved) {
                    const state = JSON.parse(saved);
                    if (state.page === 'calendar') {
                        showCalendar();
                    } else if (state.page === 'courses') {
                        goHome();
                    } else if (state.page === 'course' && state.course) {
                        currentCourse = state.course;
                        currentCategory = state.category || 'presentations';
                        document.getElementById('menuHome').classList.remove('active');
                        document.getElementById('menuCourses').classList.add('active');
                        document.getElementById('menuCalendar').classList.remove('active');
                        renderCourseView();
                    } else if (state.page === 'item' && state.course && state.item !== null) {
                        currentCourse = state.course;
                        currentCategory = state.category || 'presentations';
                        viewingItem = state.item;
                        document.getElementById('menuHome').classList.remove('active');
                        document.getElementById('menuCourses').classList.add('active');
                        document.getElementById('menuCalendar').classList.remove('active');
                        renderItemDetail();
                    } else {
                        showHomePage();
                    }
                } else {
                    showHomePage();
                }
            } catch(e) {
                showHomePage();
            }
        }

        // Re-render the current page (used after cloud sync)
        function rerenderCurrentPage() {
            if (viewingItem !== null && currentCourse) {
                renderItemDetail();
            } else if (currentCourse) {
                renderCourseView();
            } else if (document.getElementById('menuCalendar').classList.contains('active')) {
                renderCalendar();
            } else if (document.getElementById('menuCourses').classList.contains('active')) {
                renderCourses();
            } else {
                renderHomePage();
            }
        }

        function createDefaultData() {
            COURSES.forEach(course => {
                appData[course.id] = {};
                CATEGORIES.forEach(cat => {
                    appData[course.id][cat.id] = [];
                    let count = 0, prefix = '';
                    if (cat.id === 'presentations') { count = 12; prefix = 'מצגת'; }
                    else if (cat.id === 'summariesCourse') { count = 4; prefix = 'סיכום קורס'; }
                    else if (cat.id === 'summariesPractice') { count = 4; prefix = 'סיכום תרגול'; }
                    else if (cat.id === 'homework') { count = 6; prefix = 'שיעורי בית'; }
                    else if (cat.id === 'hwSolutions') { count = 6; prefix = 'פתרון ש"ב'; }
                    else if (cat.id === 'assignments') { count = 3; prefix = 'עבודה'; }
                    else if (cat.id === 'assignmentSolutions') { count = 3; prefix = 'פתרון עבודה'; }
                    else if (cat.id === 'formulas') { count = 1; prefix = 'דף נוסחאות'; }

                    for (let i = 1; i <= count; i++) {
                        appData[course.id][cat.id].push({
                            title: count === 1 ? prefix : `${prefix} ${i}`,
                            fileName: null,
                            fileType: null,
                            fileData: null,
                            uploader: null,
                            uploadDate: null,
                            completed: false
                        });
                    }
                });
            });
        }

        let db = null;

        function openDB() {
            return new Promise((resolve) => {
                try {
                    const request = indexedDB.open('StudyHubDB', 1);
                    request.onerror = (e) => {
                        console.error('DB open error:', e);
                        resolve(null);
                    };
                    request.onsuccess = () => {
                        db = request.result;
                        console.log('DB opened successfully');
                        resolve(db);
                    };
                    request.onupgradeneeded = (e) => {
                        console.log('DB upgrade needed');
                        const database = e.target.result;
                        if (!database.objectStoreNames.contains('data')) {
                            database.createObjectStore('data', { keyPath: 'id' });
                        }
                    };
                } catch(e) {
                    console.error('DB exception:', e);
                    resolve(null);
                }
            });
        }

        // Load data - localStorage INSTANT, cloud in background
        function loadData() {
            // Load from localStorage INSTANTLY
            const localData = localStorage.getItem('studyhub_data');
            if (localData) {
                try {
                    appData = JSON.parse(localData);
                    console.log('💾 Loaded');
                } catch(e) {}
            }

            // If no data, create defaults
            if (!appData || Object.keys(appData).length === 0) {
                createDefaultData();
                localStorage.setItem('studyhub_data', JSON.stringify(appData));
            }

            // Sync with cloud in background (non-blocking)
            syncFromCloud();
        }

        // Background cloud sync - CLOUD IS SOURCE OF TRUTH
        function syncFromCloud() {
            // Skip if we're currently pushing to cloud (prevent race condition)
            if (isSyncing) {
                console.log('⏳ Sync in progress, skipping...');
                return;
            }

            // Capture version at start of fetch
            const versionAtStart = syncVersion;

            console.log('🔄 Syncing with cloud...');
            fetch(`https://api.github.com/gists/${GIST_ID}`, {
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            }).then(response => {
                console.log('📡 Cloud status:', response.status);
                if (response.ok) return response.json();
                throw new Error('Cloud response not ok');
            }).then(gist => {
                // Check if data was saved while we were fetching - if so, abort
                if (syncVersion !== versionAtStart) {
                    console.log('⏭️ Data changed during fetch, skipping cloud apply');
                    return;
                }

                if (!gist) {
                    console.log('❌ No gist returned');
                    return;
                }
                const content = gist.files[GIST_FILENAME]?.content;
                console.log('📄 Cloud content length:', content?.length || 0);

                let cloudJson = { appdata: {}, calendar: {} };
                if (content) {
                    try {
                        cloudJson = JSON.parse(content);
                    } catch(e) {
                        console.log('❌ Cloud parse error:', e);
                    }
                }

                if (cloudJson.calendar) cloudCalendar = cloudJson.calendar;
                if (cloudJson.schoolSchedule && Object.keys(cloudJson.schoolSchedule).length > 0) {
                    schoolSchedule = cloudJson.schoolSchedule;
                    localStorage.setItem('studyhub_school_schedule', JSON.stringify(schoolSchedule));
                    mergeAllEvents();
                }

                const cloudHasData = cloudJson.appdata && Object.keys(cloudJson.appdata).length > 0;
                const localHasData = appData && Object.keys(appData).length > 0;

                console.log('☁️ Cloud has data:', cloudHasData, '| 💾 Local has data:', localHasData);

                if (cloudHasData) {
                    // Cloud has data - USE IT (cloud is source of truth)
                    appData = cloudJson.appdata;
                    localStorage.setItem('studyhub_data', JSON.stringify(appData));
                    rerenderCurrentPage();
                    console.log('✅ Loaded from cloud');
                } else if (localHasData) {
                    // Only local has data - push to cloud
                    syncToCloud();
                    console.log('✅ Pushed local to cloud');
                } else {
                    console.log('⚠️ No data anywhere');
                }
            }).catch(e => {
                console.log('❌ Cloud fetch error:', e);
            });
        }

        // Merge two app data objects - combine all items from both
        function mergeAppData(data1, data2) {
            const merged = JSON.parse(JSON.stringify(data1));

            for (const courseId of Object.keys(data2)) {
                if (!merged[courseId]) {
                    merged[courseId] = data2[courseId];
                    continue;
                }

                for (const catId of Object.keys(data2[courseId])) {
                    if (!merged[courseId][catId]) {
                        merged[courseId][catId] = data2[courseId][catId];
                        continue;
                    }

                    // Merge items from data2 into merged
                    const items2 = data2[courseId][catId];
                    for (const item of items2) {
                        // Check if item already exists (by name)
                        const exists = merged[courseId][catId].some(m => m.name === item.name);
                        if (!exists) {
                            merged[courseId][catId].push(item);
                        } else {
                            // Merge notes and files from this item
                            const existingItem = merged[courseId][catId].find(m => m.name === item.name);
                            if (existingItem) {
                                // Merge notes
                                if (item.notes) {
                                    if (!existingItem.notes) existingItem.notes = [];
                                    for (const note of item.notes) {
                                        const noteExists = existingItem.notes.some(n => n.text === note.text);
                                        if (!noteExists) {
                                            existingItem.notes.push(note);
                                        }
                                    }
                                }
                                // Merge files
                                if (item.files) {
                                    if (!existingItem.files) existingItem.files = [];
                                    for (const file of item.files) {
                                        const fileExists = existingItem.files.some(f => f.fileName === file.fileName);
                                        if (!fileExists) {
                                            existingItem.files.push(file);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            return merged;
        }

        // Save data ONLY to cloud
        // Save to localStorage instantly, sync to cloud in background
        let cloudCalendar = {};
        let isSyncing = false; // Prevent race condition
        let syncVersion = 0; // Track sync versions to prevent stale overwrites

        function saveData() {
            // Save to localStorage INSTANTLY
            localStorage.setItem('studyhub_data', JSON.stringify(appData));

            // Increment version to invalidate any in-flight syncFromCloud
            syncVersion++;

            // Sync to cloud in background (non-blocking)
            syncToCloud();
        }

        async function syncToCloud() {
            isSyncing = true;
            try {
                const cloudJson = { appdata: appData, calendar: cloudCalendar, schoolSchedule: schoolSchedule };
                await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: { [GIST_FILENAME]: { content: JSON.stringify(cloudJson) } }
                    })
                });
                console.log('☁️ Synced to cloud');
            } catch (error) {
                console.log('Sync failed:', error);
            }
            isSyncing = false;
        }

        // Export data to file
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'studyhub_backup.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('הנתונים יוצאו בהצלחה!');
        }

        // Import data from file
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        appData = JSON.parse(ev.target.result);
                        saveData();
                        showToast('הנתונים יובאו בהצלחה!');
                        renderCourses();
                    } catch(err) {
                        alert('שגיאה בקריאת הקובץ');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ========== NAVIGATION ==========
        function showHomePage() {
            currentCourse = null;
            currentCategory = null;
            viewingItem = null;
            document.getElementById('menuHome').classList.add('active');
            document.getElementById('menuCourses').classList.remove('active');
            document.getElementById('menuCalendar').classList.remove('active');
            renderHomePage();
            savePageState();
        }

        function renderHomePage() {
            const main = document.getElementById('mainContent');

            // Get greeting based on time of day
            const hour = new Date().getHours();
            let greeting = 'שלום';
            if (hour >= 5 && hour < 12) {
                greeting = 'בוקר טוב';
            } else if (hour >= 12 && hour < 17) {
                greeting = 'צהריים טובים';
            } else if (hour >= 17 && hour < 21) {
                greeting = 'ערב טוב';
            } else {
                greeting = 'לילה טוב';
            }

            // Get username
            let username = localStorage.getItem('studyhub_username') || 'אורח';

            // Get upcoming events (next 7 days)
            const today = new Date();
            const upcomingEvents = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const events = calendarEvents[dateStr] || [];
                events.forEach(ev => {
                    upcomingEvents.push({ ...ev, date: dateStr, dateObj: date });
                });
            }

            // Get total counts
            let totalFiles = 0;
            let totalNotes = 0;
            COURSES.forEach(course => {
                CATEGORIES.forEach(cat => {
                    const items = appData[course.id]?.[cat.id] || [];
                    items.forEach(item => {
                        totalFiles += (item.files?.length || 0) + (item.fileData ? 1 : 0);
                        totalNotes += item.notes?.length || 0;
                    });
                });
            });

            // Find next school day
            const todayDate = new Date();
            todayDate.setHours(0,0,0,0);
            const sortedDates = Object.keys(schoolSchedule).sort();
            let nextSchoolDate = null;
            for (const dateStr of sortedDates) {
                const d = new Date(dateStr);
                if (d >= todayDate) {
                    nextSchoolDate = dateStr;
                    break;
                }
            }

            let nextSchoolDayHtml = '<p style="color: #6b7280; text-align: center;">אין ימי לימוד קרובים</p>';
            if (nextSchoolDate && calendarEvents[nextSchoolDate]) {
                const nDate = new Date(nextSchoolDate);
                const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
                const dayName = dayNames[nDate.getDay()];
                const dateDisplay = nDate.toLocaleDateString('he-IL', { day: 'numeric', month: 'long' });
                const events = calendarEvents[nextSchoolDate];

                // Sort: courses first, then homework/assignments, then tests last
                const sortedEvents = [...events].sort((a, b) => {
                    const order = { 'course': 0, 'homework': 1, 'assignment': 1, 'test': 2 };
                    return (order[a.type] || 0) - (order[b.type] || 0);
                });

                const classesHtml = sortedEvents.map(c => {
                    let bgColor = 'rgba(139, 92, 246, 0.1)';
                    let borderColor = '#8b5cf6';
                    if (c.type === 'test') {
                        bgColor = 'rgba(245, 158, 11, 0.15)';
                        borderColor = '#f59e0b';
                    } else if (c.type === 'homework' || c.type === 'assignment') {
                        bgColor = 'rgba(239, 68, 68, 0.15)';
                        borderColor = '#ef4444';
                    }
                    return '<div style="background: ' + bgColor + '; border-radius: 10px; padding: 15px; border-right: 3px solid ' + borderColor + ';"><div style="color: #e0e7ff; font-size: 0.95rem;">' + c.name + '</div></div>';
                }).join('');
                nextSchoolDayHtml = '<div style="text-align: center; margin-bottom: 18px;"><div style="font-size: 1.5rem; color: #fff; font-weight: 600;">יום ' + dayName + '</div><div style="font-size: 1rem; color: #a78bfa;">' + dateDisplay + '</div></div><div style="display: flex; flex-direction: column; gap: 12px;">' + classesHtml + '</div>';
            }

            // Find upcoming assignments (type: assignment or homework) from calendarEvents
            const upcomingAssignments = [];
            const allCalendarDates = Object.keys(calendarEvents).sort();
            for (const dateStr of allCalendarDates) {
                const d = new Date(dateStr);
                if (d >= todayDate) {
                    const events = calendarEvents[dateStr];
                    events.forEach(ev => {
                        if (ev.type === 'assignment' || ev.type === 'homework') {
                            upcomingAssignments.push({ ...ev, date: dateStr, dateObj: d });
                        }
                    });
                }
            }
            // Sort by date and take first 5
            upcomingAssignments.sort((a, b) => a.dateObj - b.dateObj);
            const top5Assignments = upcomingAssignments.slice(0, 5);

            let assignmentsHtml = '<p style="color: #6b7280; text-align: center;">אין מטלות קרובות</p>';
            if (top5Assignments.length > 0) {
                assignmentsHtml = '<div style="display: flex; flex-direction: column; gap: 12px;">' +
                    top5Assignments.map(a => {
                        const aDate = new Date(a.date);
                        const dateDisplay = aDate.toLocaleDateString('he-IL', { day: 'numeric', month: 'short' });
                        return '<div style="background: rgba(239, 68, 68, 0.1); border-radius: 10px; padding: 15px; border-right: 3px solid #ef4444; display: flex; justify-content: space-between; align-items: center;"><div style="color: #e0e7ff; font-size: 0.95rem;">' + a.name + '</div><div style="color: #ef4444; font-size: 0.85rem; white-space: nowrap;">' + dateDisplay + '</div></div>';
                    }).join('') + '</div>';
            }

            // Find upcoming tests from calendarEvents
            const upcomingTests = [];
            for (const dateStr of allCalendarDates) {
                const d = new Date(dateStr);
                if (d >= todayDate) {
                    const events = calendarEvents[dateStr];
                    events.forEach(ev => {
                        if (ev.type === 'test') {
                            upcomingTests.push({ ...ev, date: dateStr, dateObj: d });
                        }
                    });
                }
            }
            // Sort by date and take first 5
            upcomingTests.sort((a, b) => a.dateObj - b.dateObj);
            const top5Tests = upcomingTests.slice(0, 5);

            let testsHtml = '<p style="color: #6b7280; text-align: center;">אין מבחנים קרובים</p>';
            if (top5Tests.length > 0) {
                testsHtml = '<div style="display: flex; flex-direction: column; gap: 12px;">' +
                    top5Tests.map(t => {
                        const tDate = new Date(t.date);
                        const dateDisplay = tDate.toLocaleDateString('he-IL', { day: 'numeric', month: 'short' });
                        return '<div style="background: rgba(245, 158, 11, 0.1); border-radius: 10px; padding: 15px; border-right: 3px solid #f59e0b; display: flex; justify-content: space-between; align-items: center;"><div style="color: #e0e7ff; font-size: 0.95rem;">' + t.name + '</div><div style="color: #f59e0b; font-size: 0.85rem; white-space: nowrap;">' + dateDisplay + '</div></div>';
                    }).join('') + '</div>';
            }

            main.innerHTML = `
                <style>
                    .home-greeting {
                        background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.1));
                        border: 1px solid rgba(139, 92, 246, 0.25);
                        border-radius: 16px;
                        padding: 20px;
                        margin-bottom: 15px;
                        margin-top: 60px;
                        text-align: center;
                    }
                    .home-greeting h2 {
                        font-size: clamp(1.3rem, 4vw, 1.8rem);
                        color: #fff;
                        margin-bottom: 3px;
                    }
                    .home-greeting p {
                        color: #a78bfa;
                        font-size: clamp(0.9rem, 2.5vw, 1.05rem);
                    }
                    .home-courses-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                        gap: 12px;
                    }
                    .home-course-card {
                        background: linear-gradient(135deg, var(--course-color-20), var(--course-color-10));
                        border: 1px solid var(--course-color-40);
                        border-radius: 10px;
                        padding: 15px 10px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.15s ease-out;
                        -webkit-tap-highlight-color: transparent;
                    }
                    .home-course-card:hover, .home-course-card:active {
                        transform: translateY(-3px);
                        box-shadow: 0 10px 30px var(--course-color-30);
                    }
                    .home-info-boxes {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 15px;
                        margin-top: 20px;
                    }
                    .home-info-box {
                        background: rgba(15, 12, 41, 0.6);
                        border-radius: 14px;
                        padding: 18px;
                        min-height: 420px;
                        -webkit-backdrop-filter: blur(10px);
                        backdrop-filter: blur(10px);
                    }
                    .home-info-box h3 {
                        margin-bottom: 15px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        font-size: 1rem;
                    }
                    @media (max-width: 900px) {
                        .home-info-boxes {
                            grid-template-columns: 1fr 1fr;
                        }
                        .home-info-box:first-child {
                            grid-column: 1 / -1;
                        }
                    }
                    @media (max-width: 600px) {
                        .home-greeting {
                            margin-top: 15px;
                        }
                        .home-info-boxes {
                            grid-template-columns: 1fr;
                        }
                        .home-info-box {
                            min-height: auto;
                            padding: 15px;
                        }
                        .home-info-box:first-child {
                            grid-column: auto;
                        }
                        .home-courses-grid {
                            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                            gap: 8px;
                        }
                        .home-course-card {
                            padding: 12px 8px;
                        }
                        .home-course-card i {
                            font-size: 1.2rem !important;
                        }
                        .home-course-card div {
                            font-size: 0.75rem !important;
                        }
                    }
                </style>
                <h1 class="page-title" style="margin-bottom: 15px;">דף בית</h1>

                <div class="home-greeting">
                    <h2>${greeting}, ${username}!</h2>
                    <p>מה נלמד היום?</p>
                </div>

                <div style="background: rgba(15, 12, 41, 0.6); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 14px; padding: 18px; margin-bottom: 20px; -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);">
                    <h3 style="color: #a78bfa; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; font-size: 1rem;">
                        <i class="fas fa-th-large"></i>
                        גישה מהירה לקורסים
                    </h3>
                    <div class="home-courses-grid">
                        ${COURSES.map(course => `
                            <div class="home-course-card" onclick="selectCourse(${course.id})" style="--course-color-20: ${course.color}20; --course-color-10: ${course.color}10; --course-color-40: ${course.color}40; --course-color-30: ${course.color}30;">
                                <i class="fas ${course.icon}" style="font-size: 1.4rem; color: ${course.color}; margin-bottom: 8px; display: block;"></i>
                                <div style="color: #e0e7ff; font-size: 0.85rem;">${course.name}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="home-info-boxes">
                    <!-- Box 1: Next School Day -->
                    <div class="home-info-box" style="border: 1px solid rgba(139, 92, 246, 0.2);">
                        <h3 style="color: #a78bfa;">
                            <i class="fas fa-school"></i>
                            יום לימודים הבא
                        </h3>
                        ${nextSchoolDayHtml}
                    </div>

                    <!-- Box 2: Upcoming Assignments -->
                    <div class="home-info-box" style="border: 1px solid rgba(239, 68, 68, 0.2);">
                        <h3 style="color: #ef4444;">
                            <i class="fas fa-tasks"></i>
                            מטלות קרובות
                        </h3>
                        ${assignmentsHtml}
                    </div>

                    <!-- Box 3: Upcoming Tests -->
                    <div class="home-info-box" style="border: 1px solid rgba(245, 158, 11, 0.2);">
                        <h3 style="color: #f59e0b;">
                            <i class="fas fa-file-alt"></i>
                            מבחנים קרובים
                        </h3>
                        ${testsHtml}
                    </div>
                </div>
            `;
        }

        function goHome() {
            currentCourse = null;
            currentCategory = null;
            viewingItem = null;
            document.getElementById('menuHome').classList.remove('active');
            document.getElementById('menuCourses').classList.add('active');
            document.getElementById('menuCalendar').classList.remove('active');
            renderCourses();
            savePageState();
        }

        // ========== CALENDAR ==========
        // School schedule data (now synced to cloud)
        let schoolSchedule = {
            // December 2025 - Sundays
            '2025-12-07': [
                { name: 'מבנה נתונים (ת) 08:15-09:45 כיתה 312', type: 'course', id: 1 },
                { name: 'בסיסי נתונים (ת) 10:00-11:30 כיתה 312', type: 'course', id: 2 },
                { name: 'מתמ\' 2 (ת) 11:45-13:15 כיתה 312', type: 'course', id: 3 },
                { name: 'מתמ\' בדידה (ת) 13:30-15:00 כיתה 312', type: 'course', id: 4 }
            ],
            '2025-12-14': [
                { name: 'מבנה נתונים (ת) 08:15-09:45 כיתה 312', type: 'course', id: 1 },
                { name: 'בסיסי נתונים (ת) 10:00-11:30 כיתה 312', type: 'course', id: 2 },
                { name: 'מתמ\' 2 (ת) 11:45-13:15 כיתה 312', type: 'course', id: 3 },
                { name: 'מתמ\' בדידה (ת) 13:30-15:00 כיתה 312', type: 'course', id: 4 }
            ],
            '2025-12-21': [
                { name: 'מבנה נתונים (ת) 08:15-09:45 כיתה 312', type: 'course', id: 1 },
                { name: 'בסיסי נתונים (ת) 10:00-11:30 כיתה 312', type: 'course', id: 2 },
                { name: 'מתמ\' 2 (ת) 11:45-13:15 כיתה 312', type: 'course', id: 3 },
                { name: 'מתמ\' בדידה (ת) 13:30-15:00 כיתה 312', type: 'course', id: 4 }
            ],
            '2025-12-28': [
                { name: 'מבנה נתונים (ת) 08:15-09:45 כיתה 312', type: 'course', id: 1 },
                { name: 'בסיסי נתונים (ת) 10:00-11:30 כיתה 312', type: 'course', id: 2 },
                { name: 'מתמ\' 2 (ת) 11:45-13:15 כיתה 312', type: 'course', id: 3 },
                { name: 'מתמ\' בדידה (ת) 13:30-15:00 כיתה 312', type: 'course', id: 4 }
            ],
            // December 2025 - Tuesdays
            '2025-12-02': [
                { name: 'מתמ\' 2 08:15-10:35 כיתה 365', type: 'course', id: 5 },
                { name: 'מתמ\' בדידה 10:55-13:15 כיתה 365', type: 'course', id: 6 },
                { name: 'אבטחת מידע 13:35-15:55 כיתה 365', type: 'course', id: 7 },
                { name: 'אנגלית ב\' 19:05-22:20 כיתה 303', type: 'course', id: 8 }
            ],
            '2025-12-09': [
                { name: 'מתמ\' 2 08:15-10:35 כיתה 365', type: 'course', id: 5 },
                { name: 'מתמ\' בדידה 10:55-13:15 כיתה 365', type: 'course', id: 6 },
                { name: 'אבטחת מידע 13:35-15:55 כיתה 365', type: 'course', id: 7 },
                { name: 'אנגלית ב\' 19:05-22:20 כיתה 303', type: 'course', id: 8 }
            ],
            '2025-12-16': [
                { name: 'מתמ\' 2 08:15-10:35 כיתה 365', type: 'course', id: 5 },
                { name: 'מתמ\' בדידה 10:55-13:15 כיתה 365', type: 'course', id: 6 },
                { name: 'אבטחת מידע 13:35-15:55 כיתה 365', type: 'course', id: 7 },
                { name: 'אנגלית ב\' 19:05-22:20 כיתה 303', type: 'course', id: 8 }
            ],
            '2025-12-23': [
                { name: 'מתמ\' 2 08:15-10:35 כיתה 365', type: 'course', id: 5 },
                { name: 'מתמ\' בדידה 10:55-13:15 כיתה 365', type: 'course', id: 6 },
                { name: 'אבטחת מידע 13:35-15:55 כיתה 365', type: 'course', id: 7 },
                { name: 'אנגלית ב\' 19:05-22:20 כיתה 303', type: 'course', id: 8 }
            ],
            '2025-12-30': [
                { name: 'מתמ\' 2 08:15-10:35 כיתה 365', type: 'course', id: 5 },
                { name: 'מתמ\' בדידה 10:55-13:15 כיתה 365', type: 'course', id: 6 },
                { name: 'אבטחת מידע 13:35-15:55 כיתה 365', type: 'course', id: 7 },
                { name: 'אנגלית ב\' 19:05-22:20 כיתה 303', type: 'course', id: 8 }
            ],
            // December 2025 - Thursdays
            '2025-12-04': [
                { name: 'מתמ\' בדידה (עוגן) 08:15-09:45 זום', type: 'course', id: 9 },
                { name: 'בסיסי נתונים (עוגן) 16:00-17:30 זום', type: 'course', id: 10 },
                { name: 'מבנה נתונים (עוגן) 18:00-19:30 זום', type: 'course', id: 11 },
                { name: 'מתמ\' 2 (עוגן) 20:00-21:30 זום', type: 'course', id: 12 }
            ],
            '2025-12-11': [
                { name: 'מתמ\' בדידה (עוגן) 08:15-09:45 זום', type: 'course', id: 9 },
                { name: 'בסיסי נתונים (עוגן) 16:00-17:30 זום', type: 'course', id: 10 },
                { name: 'מבנה נתונים (עוגן) 18:00-19:30 זום', type: 'course', id: 11 },
                { name: 'מתמ\' 2 (עוגן) 20:00-21:30 זום', type: 'course', id: 12 }
            ],
            '2025-12-18': [
                { name: 'מתמ\' בדידה (עוגן) 08:15-09:45 זום', type: 'course', id: 9 },
                { name: 'בסיסי נתונים (עוגן) 16:00-17:30 זום', type: 'course', id: 10 },
                { name: 'מבנה נתונים (עוגן) 18:00-19:30 זום', type: 'course', id: 11 },
                { name: 'מתמ\' 2 (עוגן) 20:00-21:30 זום', type: 'course', id: 12 },
                { name: '📝 עבודה - מבנה נתונים (עד 23:55)', type: 'homework', id: 101 }
            ],
            '2025-12-25': [
                { name: 'מתמ\' בדידה (עוגן) 08:15-09:45 זום', type: 'course', id: 9 },
                { name: 'בסיסי נתונים (עוגן) 16:00-17:30 זום', type: 'course', id: 10 },
                { name: 'מבנה נתונים (עוגן) 18:00-19:30 זום', type: 'course', id: 11 },
                { name: 'מתמ\' 2 (עוגן) 20:00-21:30 זום', type: 'course', id: 12 }
            ],
            // December 2025 - Fridays
            '2025-12-05': [
                { name: 'בסיסי נתונים 08:15-10:35 זום', type: 'course', id: 13 },
                { name: 'מבנה נתונים 10:55-13:15 זום', type: 'course', id: 14 }
            ],
            '2025-12-12': [
                { name: 'בסיסי נתונים 08:15-10:35 זום', type: 'course', id: 13 },
                { name: 'מבנה נתונים 10:55-13:15 זום', type: 'course', id: 14 },
                { name: '📝 עבודה - מבנה נתונים (עד 23:55)', type: 'homework', id: 105 }
            ],
            '2025-12-19': [
                { name: 'בסיסי נתונים 08:15-10:35 זום', type: 'course', id: 13 },
                { name: 'מבנה נתונים 10:55-13:15 זום', type: 'course', id: 14 }
            ],
            '2025-12-20': [
                { name: '📝 עבודה - בסיסי נתונים (עד 08:00)', type: 'homework', id: 102 }
            ],
            '2025-12-26': [
                { name: 'בסיסי נתונים 08:15-10:35 זום', type: 'course', id: 13 },
                { name: 'מבנה נתונים 10:55-13:15 זום', type: 'course', id: 14 }
            ],
            // January 2026 - Thursdays
            '2026-01-01': [
                { name: 'מתמ\' בדידה (עוגן) 08:15-09:45 זום', type: 'course', id: 9 },
                { name: 'בסיסי נתונים (עוגן) 16:00-17:30 זום', type: 'course', id: 10 },
                { name: 'מבנה נתונים (עוגן) 18:00-19:30 זום', type: 'course', id: 11 },
                { name: 'מתמ\' 2 (עוגן) 20:00-21:30 זום', type: 'course', id: 12 },
                { name: '📝 עבודה - מתמטיקה 2 (עד 09:00)', type: 'homework', id: 103 }
            ],
            '2026-01-08': [
                { name: 'מתמ\' בדידה (עוגן) 08:15-09:45 זום', type: 'course', id: 9 },
                { name: 'בסיסי נתונים (עוגן) 16:00-17:30 זום', type: 'course', id: 10 },
                { name: 'מבנה נתונים (עוגן) 18:00-19:30 זום', type: 'course', id: 11 },
                { name: 'מתמ\' 2 (עוגן) 20:00-21:30 זום', type: 'course', id: 12 }
            ],
            '2026-01-15': [
                { name: 'מתמ\' בדידה (עוגן) 08:15-09:45 זום', type: 'course', id: 9 },
                { name: 'בסיסי נתונים (עוגן) 16:00-17:30 זום', type: 'course', id: 10 },
                { name: 'מבנה נתונים (עוגן) 18:00-19:30 זום', type: 'course', id: 11 },
                { name: 'מתמ\' 2 (עוגן) 20:00-21:30 זום', type: 'course', id: 12 }
            ],
            '2026-01-22': [
                { name: 'מתמ\' בדידה (עוגן) 08:15-09:45 זום', type: 'course', id: 9 },
                { name: 'בסיסי נתונים (עוגן) 16:00-17:30 זום', type: 'course', id: 10 },
                { name: 'מבנה נתונים (עוגן) 18:00-19:30 זום', type: 'course', id: 11 },
                { name: 'מתמ\' 2 (עוגן) 20:00-21:30 זום', type: 'course', id: 12 }
            ],
            // January 2026 - Fridays
            '2026-01-02': [
                { name: 'בסיסי נתונים 08:15-10:35 זום', type: 'course', id: 13 },
                { name: 'מבנה נתונים 10:55-13:15 זום', type: 'course', id: 14 }
            ],
            '2026-01-09': [
                { name: 'בסיסי נתונים 08:15-10:35 זום', type: 'course', id: 13 },
                { name: 'מבנה נתונים 10:55-13:15 זום', type: 'course', id: 14 }
            ],
            '2026-01-16': [
                { name: 'בסיסי נתונים 08:15-10:35 זום', type: 'course', id: 13 },
                { name: 'מבנה נתונים 10:55-13:15 זום', type: 'course', id: 14 }
            ],
            '2026-01-23': [
                { name: 'בסיסי נתונים 08:15-10:35 זום', type: 'course', id: 13 },
                { name: 'מבנה נתונים 10:55-13:15 זום', type: 'course', id: 14 }
            ],
            // January 2026 - Sundays
            '2026-01-04': [
                { name: 'מבנה נתונים (ת) 08:15-09:45 כיתה 312', type: 'course', id: 1 },
                { name: 'בסיסי נתונים (ת) 10:00-11:30 כיתה 312', type: 'course', id: 2 },
                { name: 'מתמ\' 2 (ת) 11:45-13:15 כיתה 312', type: 'course', id: 3 },
                { name: 'מתמ\' בדידה (ת) 13:30-15:00 כיתה 312', type: 'course', id: 4 }
            ],
            '2026-01-11': [
                { name: 'מבנה נתונים (ת) 08:15-09:45 כיתה 312', type: 'course', id: 1 },
                { name: 'בסיסי נתונים (ת) 10:00-11:30 כיתה 312', type: 'course', id: 2 },
                { name: 'מתמ\' 2 (ת) 11:45-13:15 כיתה 312', type: 'course', id: 3 },
                { name: 'מתמ\' בדידה (ת) 13:30-15:00 כיתה 312', type: 'course', id: 4 }
            ],
            '2026-01-18': [
                { name: 'מבנה נתונים (ת) 08:15-09:45 כיתה 312', type: 'course', id: 1 },
                { name: 'בסיסי נתונים (ת) 10:00-11:30 כיתה 312', type: 'course', id: 2 },
                { name: 'מתמ\' 2 (ת) 11:45-13:15 כיתה 312', type: 'course', id: 3 },
                { name: 'מתמ\' בדידה (ת) 13:30-15:00 כיתה 312', type: 'course', id: 4 }
            ],
            '2026-01-25': [
                { name: 'מבנה נתונים (ת) 08:15-09:45 כיתה 312', type: 'course', id: 1 },
                { name: 'בסיסי נתונים (ת) 10:00-11:30 כיתה 312', type: 'course', id: 2 },
                { name: 'מתמ\' 2 (ת) 11:45-13:15 כיתה 312', type: 'course', id: 3 },
                { name: 'מתמ\' בדידה (ת) 13:30-15:00 כיתה 312', type: 'course', id: 4 }
            ],
            // January 2026 - Tuesdays
            '2026-01-06': [
                { name: 'מתמ\' 2 08:15-10:35 כיתה 365', type: 'course', id: 5 },
                { name: 'מתמ\' בדידה 10:55-13:15 כיתה 365', type: 'course', id: 6 },
                { name: 'אבטחת מידע 13:35-15:55 כיתה 365', type: 'course', id: 7 },
                { name: 'אנגלית ב\' 19:05-22:20 כיתה 303', type: 'course', id: 8 },
                { name: '📝 עבודה - מתמטיקה בדידה (עד 09:00)', type: 'homework', id: 104 }
            ],
            '2026-01-13': [
                { name: 'מתמ\' 2 08:15-10:35 כיתה 365', type: 'course', id: 5 },
                { name: 'מתמ\' בדידה 10:55-13:15 כיתה 365', type: 'course', id: 6 },
                { name: 'אבטחת מידע 13:35-15:55 כיתה 365', type: 'course', id: 7 },
                { name: 'אנגלית ב\' 19:05-22:20 כיתה 303', type: 'course', id: 8 }
            ],
            '2026-01-20': [
                { name: 'מתמ\' 2 08:15-10:35 כיתה 365', type: 'course', id: 5 },
                { name: 'מתמ\' בדידה 10:55-13:15 כיתה 365', type: 'course', id: 6 },
                { name: 'אבטחת מידע 13:35-15:55 כיתה 365', type: 'course', id: 7 },
                { name: 'אנגלית ב\' 19:05-22:20 כיתה 303', type: 'course', id: 8 }
            ],
            // ========== TESTS - מועד א' ==========
            '2026-02-01': [
                { name: '📚 מבחן - אנגלית מתקדמים ב\' (16:00-18:15)', type: 'test', id: 201 }
            ],
            '2026-02-05': [
                { name: '📚 מבחן - אבטחת מידע וסייבר (09:00-10:30)', type: 'test', id: 202 }
            ],
            '2026-02-10': [
                { name: '📚 מבחן - מתמטיקה 2 (09:00-11:00)', type: 'test', id: 203 }
            ],
            '2026-02-15': [
                { name: '📚 מבחן - בסיסי נתונים (09:00-12:00)', type: 'test', id: 204 }
            ],
            '2026-02-19': [
                { name: '📚 מבחן - מבנה נתונים (09:00-12:00)', type: 'test', id: 205 }
            ],
            '2026-02-25': [
                { name: '📚 מבחן - מתמטיקה בדידה (09:00-11:00)', type: 'test', id: 206 }
            ],
            // ========== TESTS - מועד ב' ==========
            '2026-03-05': [
                { name: '📚 מבחן - אנגלית מתקדמים ב\' (16:00-18:15)', type: 'test', id: 211 }
            ],
            '2026-03-11': [
                { name: '📚 מבחן - אבטחת מידע וסייבר (12:00-13:30)', type: 'test', id: 212 }
            ],
            '2026-03-18': [
                { name: '📚 מבחן - מתמטיקה 2 (12:00-14:00)', type: 'test', id: 213 }
            ],
            '2026-03-25': [
                { name: '📚 מבחן - בסיסי נתונים (12:00-15:00)', type: 'test', id: 214 }
            ],
            '2026-04-15': [
                { name: '📚 מבחן - מבנה נתונים (12:00-15:00)', type: 'test', id: 215 }
            ],
            '2026-04-29': [
                { name: '📚 מבחן - מתמטיקה בדידה (12:00-14:00)', type: 'test', id: 216 }
            ]
        };

        let cloudEvents = {};
        let calendarEvents = {};
        let userAddedEvents = {}; // Store user-added events separately
        let currentCalendarDate = new Date();
        let selectedCalendarDate = null;
        let cloudSyncEnabled = true;

        // Merge all events into calendarEvents
        function mergeAllEvents() {
            // Start with school schedule
            calendarEvents = JSON.parse(JSON.stringify(schoolSchedule));

            // Merge user-added events
            for (const [date, events] of Object.entries(userAddedEvents)) {
                if (!calendarEvents[date]) {
                    calendarEvents[date] = [];
                }
                events.forEach(event => {
                    const exists = calendarEvents[date].some(e => e.id === event.id);
                    if (!exists) {
                        calendarEvents[date].push(event);
                    }
                });
            }
        }

        // Load events from cloud and localStorage
        async function loadCalendarEvents() {
            // First load from localStorage (immediate display)
            const stored = localStorage.getItem('studyhub_user_events');
            userAddedEvents = JSON.parse(stored || '{}');
            mergeAllEvents();

            // Then sync with cloud - CLOUD IS THE SOURCE OF TRUTH
            if (cloudSyncEnabled) {
                try {
                    const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (response.ok) {
                        const gist = await response.json();
                        const content = gist.files[GIST_FILENAME]?.content;
                        let cloudJson = { appdata: {}, calendar: {} };
                        if (content) {
                            try {
                                cloudJson = JSON.parse(content);
                            } catch(e) {}
                        }

                        const cloudHasCalendar = cloudJson.calendar && Object.keys(cloudJson.calendar).length > 0;
                        const localHasCalendar = Object.keys(userAddedEvents).length > 0;

                        if (cloudHasCalendar) {
                            // Cloud has calendar - USE IT (cloud is source of truth)
                            userAddedEvents = cloudJson.calendar;
                            localStorage.setItem('studyhub_user_events', JSON.stringify(userAddedEvents));
                            mergeAllEvents();
                            console.log('📅 Calendar loaded from cloud');
                        } else if (localHasCalendar) {
                            // Only local has calendar - push to cloud
                            saveToCloud();
                            console.log('📅 Calendar pushed to cloud');
                        }
                    }
                } catch (error) {
                    console.log('Calendar cloud sync failed:', error);
                }
            }
        }

        // Save calendar events to cloud and localStorage
        async function saveToCloud() {
            localStorage.setItem('studyhub_user_events', JSON.stringify(userAddedEvents));
            if (!cloudSyncEnabled) return;

            try {
                let cloudJson = { appdata: {}, calendar: {} };
                try {
                    const getResponse = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (getResponse.ok) {
                        const gist = await getResponse.json();
                        const content = gist.files[GIST_FILENAME]?.content;
                        if (content) cloudJson = JSON.parse(content);
                    }
                } catch(e) {}

                cloudJson.calendar = userAddedEvents;
                cloudJson.schoolSchedule = schoolSchedule;

                await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: { [GIST_FILENAME]: { content: JSON.stringify(cloudJson) } }
                    })
                });
            } catch (error) {
                console.log('Calendar cloud save failed:', error);
            }
        }

        // Add user event
        function addUserEvent(date, event) {
            if (!userAddedEvents[date]) {
                userAddedEvents[date] = [];
            }
            userAddedEvents[date].push(event);
            mergeAllEvents();
        }

        // Remove user event
        function removeUserEvent(date, eventId) {
            console.log('🗑️ Deleting event:', eventId, 'from date:', date);
            console.log('📅 userAddedEvents before:', JSON.stringify(userAddedEvents[date]));

            if (userAddedEvents[date]) {
                userAddedEvents[date] = userAddedEvents[date].filter(e => e.id !== eventId);
                if (userAddedEvents[date].length === 0) {
                    delete userAddedEvents[date];
                }
            }

            console.log('📅 userAddedEvents after:', JSON.stringify(userAddedEvents[date]));
            localStorage.setItem('studyhub_user_events', JSON.stringify(userAddedEvents));
            mergeAllEvents();
        }

        // Update user event
        function updateUserEvent(date, eventId, newName, newType) {
            if (userAddedEvents[date]) {
                const event = userAddedEvents[date].find(e => e.id === eventId);
                if (event) {
                    event.name = newName;
                    event.type = newType;
                }
            }
            localStorage.setItem('studyhub_user_events', JSON.stringify(userAddedEvents));
            mergeAllEvents();
        }

        // Initialize calendar events
        loadCalendarEvents();

        const hebrewMonths = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
        const hebrewDays = ['א׳', 'ב׳', 'ג׳', 'ד׳', 'ה׳', 'ו׳', 'ש׳'];
        const eventTypeNames = { course: 'קורס', homework: 'מטלה', test: 'מבחן' };

        async function showCalendar() {
            document.getElementById('menuHome').classList.remove('active');
            document.getElementById('menuCourses').classList.remove('active');
            document.getElementById('menuCalendar').classList.add('active');
            currentCourse = null;
            currentCategory = null;
            viewingItem = null;
            // Reload events from cloud to get latest updates
            await loadCalendarEvents();
            renderCalendar();
            savePageState();
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const today = new Date();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            let html = `
                <h2 class="page-title">לוח שנה</h2>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-nav" style="display: flex; justify-content: center; width: 100%;">
                            <button class="calendar-nav-btn" onclick="changeMonth(-1)"><i class="fas fa-chevron-right"></i></button>
                            <span class="calendar-month-year">${hebrewMonths[month]} ${year}</span>
                            <button class="calendar-nav-btn" onclick="changeMonth(1)"><i class="fas fa-chevron-left"></i></button>
                        </div>
                    </div>
                    <div class="calendar-grid">
            `;

            // Day headers
            for (let d = 0; d < 7; d++) {
                html += `<div class="calendar-day-header">${hebrewDays[d]}</div>`;
            }

            // Previous month days
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
                const dayEvents = calendarEvents[dateKey] || [];

                let eventsHtml = '';
                dayEvents.forEach(event => {
                    eventsHtml += `<div class="calendar-event ${event.type}">${event.name}</div>`;
                });

                const hasEvents = dayEvents.length > 0 ? 'has-events' : '';
                const hasHomework = dayEvents.some(e => e.type === 'homework') ? 'has-homework' : '';
                const hasTest = dayEvents.some(e => e.type === 'test') ? 'has-test' : '';
                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${hasEvents} ${hasHomework} ${hasTest}" onclick="openCalendarModal('${dateKey}')">
                        <div class="calendar-day-number">${day}</div>
                        ${eventsHtml}
                    </div>
                `;
            }

            // Next month days
            const totalCells = startDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }

            html += `</div>`;

            // Mobile list view
            const hebrewDayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
            html += `<div class="calendar-mobile-list">`;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dateObj = new Date(year, month, day);
                const dayOfWeek = dateObj.getDay();
                const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
                const dayEvents = calendarEvents[dateKey] || [];
                const hasHomeworkMobile = dayEvents.some(e => e.type === 'homework') ? 'has-homework' : '';
                const hasTestMobile = dayEvents.some(e => e.type === 'test') ? 'has-test' : '';

                // Only show days with events or today
                if (dayEvents.length > 0 || isToday) {
                    html += `
                        <div class="calendar-mobile-day ${isToday ? 'today' : ''} ${hasHomeworkMobile} ${hasTestMobile}" onclick="openCalendarModal('${dateKey}')">
                            <div class="calendar-mobile-day-header">
                                <span>יום ${hebrewDayNames[dayOfWeek]}, ${day} ${hebrewMonths[month]}</span>
                                <span>${dayEvents.length} שיעורים</span>
                            </div>
                            <div class="calendar-mobile-events">
                    `;

                    if (dayEvents.length > 0) {
                        dayEvents.forEach(event => {
                            html += `<div class="calendar-mobile-event ${event.type}">${event.name}</div>`;
                        });
                    } else {
                        html += `<div class="calendar-mobile-no-events">אין שיעורים היום</div>`;
                    }

                    html += `</div></div>`;
                }
            }

            html += `</div></div>`;
            document.getElementById('mainContent').innerHTML = html;
        }

        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function openCalendarModal(dateKey) {
            selectedCalendarDate = dateKey;
            const [year, month, day] = dateKey.split('-');
            document.getElementById('calendarModalTitle').textContent = `${parseInt(day)} ${hebrewMonths[parseInt(month) - 1]} ${year}`;
            document.getElementById('eventName').value = '';
            document.getElementById('eventType').value = 'course';
            renderCalendarEventsList();
            document.getElementById('calendarModal').style.display = 'flex';
        }

        function closeCalendarModal() {
            document.getElementById('calendarModal').style.display = 'none';
            selectedCalendarDate = null;
            editingEventIdx = null;
            document.getElementById('calendarAddBtn').innerHTML = '<i class="fas fa-plus"></i> הוסף';
            document.getElementById('eventName').value = '';
        }

        function renderCalendarEventsList() {
            const events = calendarEvents[selectedCalendarDate] || [];
            let html = '';

            if (events.length > 0) {
                events.forEach((event, idx) => {
                    html += `
                        <div class="calendar-event-item">
                            <div class="event-info">
                                <div class="event-name">${event.name}</div>
                                <div class="event-type">${eventTypeNames[event.type]}</div>
                            </div>
                            <div class="calendar-event-actions">
                                <button class="calendar-event-edit" onclick="editCalendarEvent(${idx})">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button class="calendar-event-delete" onclick="deleteCalendarEvent(${idx})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            } else {
                html = '<p style="color: #a78bfa; text-align: center;">אין אירועים ביום זה</p>';
            }

            document.getElementById('calendarEventsList').innerHTML = html;
        }

        async function deleteCalendarEvent(idx) {
            const event = calendarEvents[selectedCalendarDate][idx];
            // Check if this is a school schedule event
            const isSchoolEvent = schoolSchedule[selectedCalendarDate]?.some(e => e.id === event.id);
            if (isSchoolEvent) {
                // Delete from school schedule
                const schoolIdx = schoolSchedule[selectedCalendarDate].findIndex(e => e.id === event.id);
                if (schoolIdx !== -1) {
                    schoolSchedule[selectedCalendarDate].splice(schoolIdx, 1);
                    if (schoolSchedule[selectedCalendarDate].length === 0) {
                        delete schoolSchedule[selectedCalendarDate];
                    }
                    localStorage.setItem('studyhub_school_schedule', JSON.stringify(schoolSchedule));
                    mergeAllEvents();
                    await saveToCloud();
                    renderCalendarEventsList();
                    renderCalendar();
                    showToast('השיעור נמחק');
                }
                return;
            }
            // Remove from user events
            removeUserEvent(selectedCalendarDate, event.id);
            // Save to cloud and localStorage
            await saveToCloud();
            renderCalendarEventsList();
            renderCalendar();
            showToast('האירוע נמחק');
        }

        let editingEventIdx = null;

        function editCalendarEvent(idx) {
            const event = calendarEvents[selectedCalendarDate][idx];
            document.getElementById('eventName').value = event.name;
            document.getElementById('eventType').value = event.type;
            editingEventIdx = idx;
            document.getElementById('calendarAddBtn').innerHTML = '<i class="fas fa-save"></i> שמור שינויים';
        }

        async function saveCalendarEvent() {
            const name = document.getElementById('eventName').value.trim();
            const type = document.getElementById('eventType').value;
            const isNewEvent = editingEventIdx === null; // Check BEFORE we modify editingEventIdx

            if (!name) {
                showToast('נא להזין שם לאירוע');
                return;
            }

            if (editingEventIdx !== null) {
                // Update existing event - get the event ID first
                const event = calendarEvents[selectedCalendarDate][editingEventIdx];
                // Check if this is a school schedule event
                const isSchoolEvent = schoolSchedule[selectedCalendarDate]?.some(e => e.id === event.id);
                if (isSchoolEvent) {
                    // Update in school schedule
                    const schoolEvent = schoolSchedule[selectedCalendarDate].find(e => e.id === event.id);
                    if (schoolEvent) {
                        schoolEvent.name = name;
                        schoolEvent.type = type;
                        localStorage.setItem('studyhub_school_schedule', JSON.stringify(schoolSchedule));
                        mergeAllEvents();
                    }
                } else {
                    updateUserEvent(selectedCalendarDate, event.id, name, type);
                }
                editingEventIdx = null;
                document.getElementById('calendarAddBtn').innerHTML = '<i class="fas fa-plus"></i> הוסף';
                showToast('האירוע עודכן בהצלחה');
            } else {
                // Add new event - if it's a course, add to schoolSchedule; otherwise to userAddedEvents
                const newEvent = { name, type, id: Date.now() };
                if (type === 'course') {
                    // Add to school schedule
                    if (!schoolSchedule[selectedCalendarDate]) {
                        schoolSchedule[selectedCalendarDate] = [];
                    }
                    schoolSchedule[selectedCalendarDate].push(newEvent);
                    localStorage.setItem('studyhub_school_schedule', JSON.stringify(schoolSchedule));
                    mergeAllEvents();
                } else {
                    addUserEvent(selectedCalendarDate, newEvent);
                }
                showToast('האירוע נוסף בהצלחה');
            }

            // Save to cloud and localStorage
            await saveToCloud();
            document.getElementById('eventName').value = '';
            renderCalendarEventsList();
            renderCalendar();

            // Refresh notifications if a NEW test/homework/assignment was added
            if (isNewEvent && (type === 'test' || type === 'assignment' || type === 'homework')) {
                // Check if this event is within notification range (3 days)
                const eventDate = new Date(selectedCalendarDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                eventDate.setHours(0, 0, 0, 0);
                const diffDays = Math.floor((eventDate - today) / (1000 * 60 * 60 * 24));

                if (diffDays >= 0 && diffDays <= 3) {
                    // Mark all existing notifications as seen, except the new one
                    await refreshNotificationsAfterNewEvent(selectedCalendarDate, name);
                }
            }
        }

        // Separate function to handle notification refresh after adding event
        async function refreshNotificationsAfterNewEvent(eventDate, eventName) {
            const username = localStorage.getItem('studyhub_username') || 'guest';

            // Load latest from cloud
            await loadNotificationsFromCloud();

            // Get all current notifications (including the new one)
            const { urgent, important, reminder } = getAllNotifications();
            const allNotifications = [...urgent, ...important, ...reminder];

            // Mark ALL notifications EXCEPT the new one as seen for this user
            if (!cloudNotifications[username]) cloudNotifications[username] = { seenNotifications: [], dismissed: {} };
            if (!cloudNotifications[username].seenNotifications) cloudNotifications[username].seenNotifications = [];

            const newNotificationId = `${eventDate}_${eventName}`;

            allNotifications.forEach(item => {
                const notificationId = `${item.date}_${item.name}`;
                // Mark as seen UNLESS it's the notification we just added
                if (notificationId !== newNotificationId && !cloudNotifications[username].seenNotifications.includes(notificationId)) {
                    cloudNotifications[username].seenNotifications.push(notificationId);
                }
            });

            // Save to cloud
            await saveNotificationsToCloud();

            // Re-render to show only the new notification
            renderNotifications();
        }

        function selectCourse(courseId) {
            currentCourse = courseId;
            currentCategory = 'presentations';
            viewingItem = null;
            document.getElementById('menuHome').classList.remove('active');
            document.getElementById('menuCourses').classList.add('active');
            document.getElementById('menuCalendar').classList.remove('active');
            renderCourseView();
            savePageState();
        }

        function selectCategory(categoryId) {
            currentCategory = categoryId;
            viewingItem = null;
            renderCourseView();
            savePageState();
        }

        function viewItem(idx) {
            viewingItem = idx;
            renderItemDetail();
            setTimeout(setupDetailDropZone, 100);
            savePageState();
        }

        function setupDetailDropZone() {
            const dropZone = document.getElementById('detailDropZone');
            if (!dropZone) return;

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');

                const file = e.dataTransfer.files[0];
                if (file) {
                    saveFileToItem(file);
                }
            });
        }

        function handleDetailFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            saveFileToItem(file);
            input.value = '';
        }

        async function saveFileToItem(file) {
            if (file.size > 10 * 1024 * 1024) {
                alert('הקובץ גדול מדי (מקסימום 10MB)');
                return;
            }

            const item = appData[currentCourse][currentCategory][viewingItem];

            // Ensure files array exists
            if (!item.files) {
                item.files = [];
            }

            // Get uploader name
            let uploader = localStorage.getItem('studyhub_username');
            if (!uploader) {
                uploader = prompt('מה השם שלך?');
                if (uploader) {
                    localStorage.setItem('studyhub_username', uploader);
                }
            }

            // Show uploading toast
            showToast('מעלה קובץ...');

            // Upload to Cloudinary
            const cloudinaryUrl = await uploadToCloudinary(file);

            if (cloudinaryUrl) {
                // Add new file to the array
                const newFile = {
                    fileName: file.name,
                    fileType: file.type,
                    fileData: cloudinaryUrl,
                    uploader: uploader,
                    uploadDate: new Date().toISOString()
                };
                item.files.push(newFile);

                // Update legacy fields with first file
                if (item.files.length === 1) {
                    item.fileName = newFile.fileName;
                    item.fileType = newFile.fileType;
                    item.fileData = newFile.fileData;
                    item.uploader = newFile.uploader;
                    item.uploadDate = newFile.uploadDate;
                }

                saveData();
                showToast('הקובץ נוסף בהצלחה! ☁️');
                renderItemDetail();
                setTimeout(setupDetailDropZone, 100);
            } else {
                alert('שגיאה בהעלאת הקובץ. נסה שוב.');
            }
        }

        function backToList() {
            viewingItem = null;
            renderCourseView();
            savePageState();
        }

        // ========== RENDER ==========
        function renderCourses() {
            const main = document.getElementById('mainContent');

            main.innerHTML = `
                <h1 class="page-title">הקורסים שלי</h1>
                <div class="course-grid">
                    ${COURSES.map(course => {
                        const itemCount = CATEGORIES.reduce((sum, cat) => sum + (appData[course.id]?.[cat.id]?.length || 0), 0);
                        return `
                            <div class="course-card" style="--color: ${course.color}" onclick="selectCourse(${course.id})">
                                <div class="course-card-icon">
                                    <i class="fas ${course.icon}"></i>
                                </div>
                                <div class="course-card-name">${course.name}</div>
                                <div class="course-card-count">${itemCount} פריטים</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderCourseView() {
            const main = document.getElementById('mainContent');
            const course = COURSES.find(c => c.id === currentCourse);
            const category = CATEGORIES.find(c => c.id === currentCategory);
            const items = appData[currentCourse]?.[currentCategory] || [];

            main.innerHTML = `
                <button class="back-btn" onclick="goHome()">
                    <i class="fas fa-arrow-right"></i>
                    חזרה לקורסים
                </button>

                <h1 class="page-title" style="-webkit-text-fill-color: ${course.color}; text-align: center;">${course.name}</h1>

                <div class="category-bar">
                    ${CATEGORIES.map(cat => {
                        const count = appData[currentCourse]?.[cat.id]?.length || 0;
                        return `
                            <button class="category-tab ${cat.id === currentCategory ? 'active' : ''}"
                                    style="--color: ${cat.color}"
                                    onclick="selectCategory('${cat.id}')">
                                <i class="fas ${cat.icon}"></i>
                                ${cat.name}
                                <span class="count">${count}</span>
                            </button>
                        `;
                    }).join('')}
                </div>

                <div class="items-header">
                    <div class="items-title">${category.name}</div>
                    <button class="add-btn" onclick="openAddModal()">
                        <i class="fas fa-plus"></i> הוסף
                    </button>
                </div>

                <div class="items-grid" style="--color: ${category.color}">
                    ${items.length === 0 ? `
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h3>אין פריטים</h3>
                            <p>לחץ על "הוסף" כדי להתחיל</p>
                        </div>
                    ` : items.map((item, idx) => {
                        const filesCount = item.files ? item.files.length : (item.fileName ? 1 : 0);
                        const notesCount = item.notes && item.notes.length ? item.notes.length : 0;

                        // Group files by uploader - only if there are actual files
                        const uploaderCounts = {};
                        if (item.files && item.files.length > 0) {
                            item.files.forEach(file => {
                                const name = file.uploader || 'אנונימי';
                                uploaderCounts[name] = (uploaderCounts[name] || 0) + 1;
                            });
                        } else if (item.fileName && item.uploader) {
                            uploaderCounts[item.uploader] = 1;
                        }

                        const uploadersHtml = Object.keys(uploaderCounts).length > 0
                            ? Object.entries(uploaderCounts).map(([name, count]) =>
                                `<div class="uploader-line"><i class="fas fa-user"></i> ${name} <span class="uploader-count">${count} קבצים</span></div>`
                            ).join('')
                            : '';

                        const hasFiles = filesCount > 0;

                        return `
                        <div class="item-card ${item.completed ? 'completed' : ''} ${hasFiles ? 'has-file' : ''}">
                            <div class="item-header" onclick="viewItem(${idx})">
                                <div class="item-checkbox ${item.completed ? 'checked' : ''}" onclick="event.stopPropagation(); toggleComplete(${idx})">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="item-info">
                                    <div class="item-title">${item.title}</div>
                                    <div class="item-meta">
                                        ${filesCount > 0 ? `<span class="item-file-badge"><i class="fas fa-file"></i> ${filesCount} קבצים</span>` : '<span style="opacity:0.5">אין קבצים</span>'}
                                        ${notesCount > 0 ? `<span class="item-file-badge" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.1)); border-color: rgba(139, 92, 246, 0.3); color: #a78bfa;"><i class="fas fa-sticky-note"></i> ${notesCount} הערות</span>` : ''}
                                    </div>
                                    ${uploadersHtml ? `<div class="uploaders-list">${uploadersHtml}</div>` : ''}
                                </div>
                            </div>
                            <div class="item-actions">
                                <button class="item-action-btn download" onclick="event.stopPropagation(); downloadAllFiles(${idx})">
                                    <i class="fas fa-download"></i> הורד קבצים
                                </button>
                                <button class="item-action-btn delete" onclick="event.stopPropagation(); confirmDeleteFromList(${idx})">
                                    <i class="fas fa-trash"></i> מחק
                                </button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }

        function renderItemDetail() {
            const main = document.getElementById('mainContent');
            const course = COURSES.find(c => c.id === currentCourse);
            const category = CATEGORIES.find(c => c.id === currentCategory);
            const item = appData[currentCourse][currentCategory][viewingItem];

            // Ensure files array exists (migration from old single-file format)
            if (!item.files) {
                item.files = [];
                if (item.fileName) {
                    item.files.push({
                        fileName: item.fileName,
                        fileType: item.fileType,
                        fileData: item.fileData,
                        uploader: item.uploader,
                        uploadDate: item.uploadDate
                    });
                }
            }

            main.innerHTML = `
                <button class="back-btn" onclick="backToList()">
                    <i class="fas fa-arrow-right"></i>
                    חזרה ל${category.name}
                </button>

                <div class="item-detail" style="--color: ${category.color}">
                    <div class="item-detail-header">
                        <div class="item-detail-icon">
                            <i class="fas ${category.icon}"></i>
                        </div>
                        <div class="item-detail-title">${item.title}</div>
                    </div>

                    <div class="item-detail-section">
                        <h4>פרטים</h4>
                        <div class="item-detail-info">
                            <i class="fas fa-book"></i>
                            <span>${course.name} / ${category.name}</span>
                        </div>
                        <div class="item-detail-info" style="margin-top: 10px;">
                            <i class="fas fa-file"></i>
                            <span>${item.files.length} קבצים</span>
                        </div>
                    </div>

                    <div class="item-detail-section">
                        <h4>הערות</h4>
                        <div class="notes-section">
                            ${item.notes && item.notes.length > 0 ? item.notes.map((note, noteIdx) => `
                                <div class="note-item">
                                    <div class="note-header">
                                        <span class="note-author"><i class="fas fa-user"></i> ${note.author || 'אנונימי'}</span>
                                        <span class="note-date">${note.date ? new Date(note.date).toLocaleDateString('he-IL') + ' ' + new Date(note.date).toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'}) : ''}</span>
                                        <button class="note-delete" onclick="deleteNote(${noteIdx})"><i class="fas fa-times"></i></button>
                                    </div>
                                    <div class="note-text">${note.text}</div>
                                </div>
                            `).join('') : '<p style="color: #a78bfa; opacity: 0.7; text-align: center; padding: 8px; margin: 0; font-size: 0.85rem;">אין הערות עדיין</p>'}
                        </div>
                        <div class="add-note-form">
                            <textarea id="newNoteText" placeholder="כתוב הערה חדשה..."></textarea>
                            <button class="detail-btn detail-btn-primary" onclick="addNote()" style="margin-top: 8px; padding: 10px 20px; font-size: 0.9rem;">
                                <i class="fas fa-plus"></i> הוסף הערה
                            </button>
                        </div>
                    </div>

                    <div class="item-detail-section">
                        <h4>קבצים</h4>
                        <div class="files-list">
                            ${item.files.length > 0 ? item.files.map((file, idx) => `
                                <div class="file-preview" style="margin-bottom: 12px;">
                                    <i class="fas ${getFileIcon(file.fileType)}"></i>
                                    <h4>${file.fileName}</h4>
                                    <p>${file.uploader ? 'הועלה על ידי ' + file.uploader : ''} ${file.uploadDate ? '• ' + new Date(file.uploadDate).toLocaleDateString('he-IL') : ''}</p>
                                    <div class="file-preview-actions">
                                        <button class="detail-btn detail-btn-primary" onclick="viewFileAt(${idx})">
                                            <i class="fas fa-eye"></i> צפייה
                                        </button>
                                        <button class="detail-btn detail-btn-secondary" onclick="downloadFileAt(${idx})">
                                            <i class="fas fa-download"></i> הורדה
                                        </button>
                                        <button class="detail-btn detail-btn-danger" onclick="removeFileAt(${idx})" style="flex: 0.5;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('') : ''}

                            <div class="no-file" id="detailDropZone" onclick="document.getElementById('detailFileInput').click()" style="margin-top: 15px;">
                                <i class="fas fa-plus-circle"></i>
                                <h4>הוסף קובץ</h4>
                                <p>גרור או לחץ לבחירה</p>
                            </div>
                            <input type="file" id="detailFileInput" style="display:none" onchange="handleDetailFileSelect(this)">
                        </div>
                    </div>

                    <div class="detail-actions">
                        <button class="detail-btn detail-btn-secondary" onclick="openEditModal(${viewingItem})">
                            <i class="fas fa-edit"></i> ערוך שם
                        </button>
                        <button class="detail-btn detail-btn-danger" onclick="confirmDelete(${viewingItem})">
                            <i class="fas fa-trash"></i> מחק הכל
                        </button>
                    </div>

                </div>
            `;
        }

        function getFileIcon(type) {
            if (!type) return 'fa-file';
            if (type.includes('pdf')) return 'fa-file-pdf';
            if (type.includes('image')) return 'fa-file-image';
            if (type.includes('word') || type.includes('document')) return 'fa-file-word';
            if (type.includes('powerpoint') || type.includes('presentation')) return 'fa-file-powerpoint';
            if (type.includes('excel') || type.includes('sheet')) return 'fa-file-excel';
            return 'fa-file';
        }

        // ========== ITEM ACTIONS ==========
        function toggleComplete(idx) {
            appData[currentCourse][currentCategory][idx].completed = !appData[currentCourse][currentCategory][idx].completed;
            saveData();
            renderCourseView();
        }

        let pendingDeleteIdx = null;
        let pendingDeleteType = null; // 'item', 'itemList', 'note', 'file'

        function showDeleteModal(itemName, idx, deleteType = 'item') {
            pendingDeleteIdx = idx;
            pendingDeleteType = deleteType;
            document.getElementById('deleteModalText').textContent = `האם למחוק את "${itemName}"?`;
            document.getElementById('deleteModal').style.display = 'flex';
            document.getElementById('deleteModalConfirm').onclick = executeDelete;
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            pendingDeleteIdx = null;
            pendingDeleteType = null;
        }

        function executeDelete() {
            if (pendingDeleteIdx === null) {
                closeDeleteModal();
                return;
            }

            if (pendingDeleteType === 'item') {
                appData[currentCourse][currentCategory].splice(pendingDeleteIdx, 1);
                saveData();
                viewingItem = null;
                renderCourseView();
            } else if (pendingDeleteType === 'itemList') {
                appData[currentCourse][currentCategory].splice(pendingDeleteIdx, 1);
                saveData();
                showToast('הפריט נמחק');
                renderCourseView();
            } else if (pendingDeleteType === 'note') {
                const item = appData[currentCourse][currentCategory][viewingItem];
                item.notes.splice(pendingDeleteIdx, 1);
                saveData();
                showToast('ההערה נמחקה');
                renderCourseView();
                renderItemDetail();
                setTimeout(setupDetailDropZone, 100);
            } else if (pendingDeleteType === 'file') {
                const item = appData[currentCourse][currentCategory][viewingItem];
                item.files.splice(pendingDeleteIdx, 1);
                if (item.files.length > 0) {
                    item.fileName = item.files[0].fileName;
                    item.fileType = item.files[0].fileType;
                    item.fileData = item.files[0].fileData;
                } else {
                    item.fileName = null;
                    item.fileType = null;
                    item.fileData = null;
                }
                saveData();
                showToast('הקובץ נמחק');
                renderCourseView();
                renderItemDetail();
                setTimeout(setupDetailDropZone, 100);
            }
            closeDeleteModal();
        }

        function confirmDelete(idx) {
            const item = appData[currentCourse][currentCategory][idx];
            const itemName = item.name || item.title || item.text?.substring(0, 30) || 'פריט';
            showDeleteModal(itemName, idx, 'item');
        }

        function confirmDeleteFromList(idx) {
            const item = appData[currentCourse][currentCategory][idx];
            const itemName = item.name || item.title || item.text?.substring(0, 30) || 'פריט';
            showDeleteModal(itemName, idx, 'itemList');
        }

        function addNote() {
            const textArea = document.getElementById('newNoteText');
            const text = textArea.value.trim();
            if (!text) {
                showToast('נא להזין טקסט להערה');
                return;
            }

            const item = appData[currentCourse][currentCategory][viewingItem];

            // Ensure notes is an array
            if (!item.notes || !Array.isArray(item.notes)) {
                item.notes = [];
            }

            // Get author name
            let author = localStorage.getItem('studyhub_username');
            if (!author) {
                author = prompt('מה השם שלך?');
                if (author) {
                    localStorage.setItem('studyhub_username', author);
                }
            }

            // Add new note
            item.notes.push({
                text: text,
                author: author || 'אנונימי',
                date: new Date().toISOString()
            });

            saveData();
            showToast('ההערה נוספה בהצלחה!');
            renderItemDetail();
            setTimeout(setupDetailDropZone, 100);
        }

        function deleteNote(noteIdx) {
            const item = appData[currentCourse][currentCategory][viewingItem];
            const note = item.notes[noteIdx];
            const noteText = (note?.text || note)?.substring(0, 30) || 'הערה';
            showDeleteModal(noteText, noteIdx, 'note');
        }

        function quickViewFile(idx) {
            const item = appData[currentCourse][currentCategory][idx];
            // Use files array if exists, otherwise use legacy single file
            const file = item.files && item.files.length > 0 ? item.files[0] : item;
            if (file && (file.fileData || item.fileData)) {
                const fileData = file.fileData || item.fileData;
                const fileType = file.fileType || item.fileType;
                const fileName = file.fileName || item.fileName;
                const win = window.open();
                if (fileType && (fileType.includes('pdf') || fileType.includes('image'))) {
                    win.document.write(`<iframe src="${fileData}" style="width:100%;height:100%;border:none;position:fixed;top:0;left:0;"></iframe>`);
                } else {
                    win.document.write(`<html><body style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;background:#1a1a2e;color:#fff;"><div style="text-align:center;"><h2>לא ניתן להציג קובץ זה</h2><p><a href="${fileData}" download="${fileName}" style="color:#8b5cf6;">לחץ להורדה</a></p></div></body></html>`);
                }
            }
        }

        function quickDownloadFile(idx) {
            const item = appData[currentCourse][currentCategory][idx];
            // Use files array if exists, otherwise use legacy single file
            const file = item.files && item.files.length > 0 ? item.files[0] : item;
            if (file && (file.fileData || item.fileData)) {
                const link = document.createElement('a');
                link.href = file.fileData || item.fileData;
                link.download = file.fileName || item.fileName;
                link.click();
            }
        }

        function downloadAllFiles(idx) {
            const item = appData[currentCourse][currentCategory][idx];
            // Get all files
            let files = [];
            if (item.files && item.files.length > 0) {
                files = item.files;
            } else if (item.fileName) {
                files = [{ fileName: item.fileName, fileData: item.fileData }];
            }

            if (files.length === 0) {
                showToast('אין קבצים להורדה');
                return;
            }

            // Download each file with a small delay
            files.forEach((file, i) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = file.fileData;
                    link.download = file.fileName;
                    link.click();
                }, i * 300);
            });

            showToast(`מוריד ${files.length} קבצים...`);
        }

        // ========== MODAL ==========
        function openAddModal() {
            currentItemIndex = null;
            selectedFile = null;
            document.getElementById('modalTitle').textContent = 'הוסף פריט חדש';
            document.getElementById('itemName').value = '';
            document.getElementById('uploaderName').value = localStorage.getItem('studyhub_username') || '';
            renderFileZone();
            document.getElementById('modal').classList.add('active');
        }

        function openEditModal(idx) {
            currentItemIndex = idx;
            const item = appData[currentCourse][currentCategory][idx];

            if (item.fileName) {
                selectedFile = { name: item.fileName, type: item.fileType, data: item.fileData };
            } else {
                selectedFile = null;
            }

            document.getElementById('modalTitle').textContent = item.title;
            document.getElementById('itemName').value = item.title;
            document.getElementById('uploaderName').value = item.uploader || localStorage.getItem('studyhub_username') || '';
            renderFileZone();
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            selectedFile = null;
        }

        function saveItem() {
            const title = document.getElementById('itemName').value.trim();
            const uploader = document.getElementById('uploaderName').value.trim();

            if (!title) { alert('נא להזין שם'); return; }
            if (!currentCourse || !currentCategory) { alert('שגיאה'); return; }

            // Save username for next time
            if (uploader) {
                localStorage.setItem('studyhub_username', uploader);
            }

            const itemData = {
                title,
                fileName: selectedFile ? selectedFile.name : null,
                fileType: selectedFile ? selectedFile.type : null,
                fileData: selectedFile ? selectedFile.data : null,
                uploader: uploader || null,
                uploadDate: selectedFile ? new Date().toISOString() : null,
                completed: currentItemIndex !== null ? appData[currentCourse][currentCategory][currentItemIndex].completed : false
            };

            if (currentItemIndex !== null) {
                // Keep old upload info if no new file
                if (!selectedFile && appData[currentCourse][currentCategory][currentItemIndex].fileName) {
                    const oldItem = appData[currentCourse][currentCategory][currentItemIndex];
                    itemData.fileName = oldItem.fileName;
                    itemData.fileType = oldItem.fileType;
                    itemData.fileData = oldItem.fileData;
                    itemData.uploader = oldItem.uploader;
                    itemData.uploadDate = oldItem.uploadDate;
                }
                appData[currentCourse][currentCategory][currentItemIndex] = itemData;
            } else {
                appData[currentCourse][currentCategory].push(itemData);
            }

            saveData();
            closeModal();
            showToast('נשמר בהצלחה!');
            if (viewingItem !== null) {
                renderItemDetail();
            } else {
                renderCourseView();
            }
        }

        // ========== FILE ==========
        function renderFileZone() {
            const zone = document.getElementById('fileZone');
            if (selectedFile && selectedFile.uploading) {
                zone.innerHTML = `
                    <div class="file-attached">
                        <i class="fas fa-spinner fa-spin"></i>
                        <div class="file-attached-info">
                            <h4>${selectedFile.name}</h4>
                            <p>מעלה קובץ...</p>
                        </div>
                    </div>
                `;
            } else if (selectedFile) {
                zone.innerHTML = `
                    <div class="file-attached">
                        <i class="fas fa-file-alt"></i>
                        <div class="file-attached-info">
                            <h4>${selectedFile.name}</h4>
                            <p>קובץ מצורף ${selectedFile.isCloudinary ? '☁️' : ''}</p>
                        </div>
                        <button type="button" onclick="removeFile()"><i class="fas fa-times"></i></button>
                    </div>
                `;
            } else {
                zone.innerHTML = `
                    <div class="file-drop" id="fileDrop" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h4>גרור קובץ לכאן או לחץ לבחירה</h4>
                        <p>עד 10MB</p>
                    </div>
                `;
                setupDragDrop();
            }
        }

        function setupDragDrop() {
            const dropZone = document.getElementById('fileDrop');
            if (!dropZone) return;

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');

                const file = e.dataTransfer.files[0];
                if (file) {
                    processFile(file);
                }
            });
        }

        async function processFile(file) {
            if (file.size > 10 * 1024 * 1024) {
                alert('הקובץ גדול מדי (מקסימום 10MB)');
                return;
            }

            // Show uploading state
            selectedFile = { name: file.name, type: file.type, data: null, uploading: true };
            renderFileZone();

            // Upload to Cloudinary
            const cloudinaryUrl = await uploadToCloudinary(file);
            if (cloudinaryUrl) {
                selectedFile = { name: file.name, type: file.type, data: cloudinaryUrl, isCloudinary: true };
                renderFileZone();
                showToast('הקובץ הועלה בהצלחה!');
            } else {
                // Fallback to base64 for small files if Cloudinary fails
                if (file.size < 500 * 1024) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        selectedFile = { name: file.name, type: file.type, data: ev.target.result };
                        renderFileZone();
                    };
                    reader.readAsDataURL(file);
                } else {
                    selectedFile = null;
                    renderFileZone();
                    alert('שגיאה בהעלאת הקובץ. נסה שוב.');
                }
            }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            processFile(file);
            input.value = '';
        }

        function removeFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            renderFileZone();
        }

        function viewFileAt(fileIdx) {
            const item = appData[currentCourse][currentCategory][viewingItem];
            const file = item.files[fileIdx];
            if (file && file.fileData) {
                const win = window.open();
                if (file.fileType && (file.fileType.includes('pdf') || file.fileType.includes('image'))) {
                    win.document.write(`<iframe src="${file.fileData}" style="width:100%;height:100%;border:none;position:fixed;top:0;left:0;"></iframe>`);
                } else {
                    win.document.write(`<html><body style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;background:#1a1a2e;color:#fff;"><div style="text-align:center;"><h2>לא ניתן להציג קובץ זה</h2><p><a href="${file.fileData}" download="${file.fileName}" style="color:#8b5cf6;">לחץ להורדה</a></p></div></body></html>`);
                }
            }
        }

        function downloadFileAt(fileIdx) {
            const item = appData[currentCourse][currentCategory][viewingItem];
            const file = item.files[fileIdx];
            if (file && file.fileData) {
                const link = document.createElement('a');
                link.href = file.fileData;
                link.download = file.fileName;
                link.click();
            }
        }

        function removeFileAt(fileIdx) {
            const item = appData[currentCourse][currentCategory][viewingItem];
            const fileName = item.files[fileIdx]?.fileName || 'קובץ';
            showDeleteModal(fileName, fileIdx, 'file');
        }

        // Keep old functions for backwards compatibility
        function viewFile() {
            viewFileAt(0);
        }

        function downloadFile() {
            downloadFileAt(0);
        }

        // Close modal on outside click
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') closeModal();
        });

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Start
        init();
    </script>
</body>
</html>
<!-- cache bust -->
